<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Administrador</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body { background-color:#111827; color:#e0e0e0; min-height:100vh; }
    #dasha-container { width:100%; background:#1f2937; color:#e0e0e0; padding:1rem 1.5rem; border-radius:0.75rem; display:flex; align-items:center; gap:1rem; margin-bottom:1.5rem; user-select:none; flex-wrap:wrap; }
    .dashboard-card { background:#1f2937; border-radius:0.75rem; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:2rem; gap:1rem; aspect-ratio:1/1; transition:transform 0.2s, background 0.2s, box-shadow 0.2s; cursor:pointer; box-shadow:0 4px 8px rgba(0,0,0,0.3); }
    .dashboard-card:hover { background:#7c3aed; transform:translateY(-4px); box-shadow:0 8px 16px rgba(0,0,0,0.4); }
    .dashboard-card i { width:48px; height:48px; }
    .dashboard-card span { font-size:1.125rem; font-weight:600; text-align:center; color:#e0e0e0; }

    /* Sidebar */
    #profile-sidebar { position:fixed; top:0; right:0; height:100%; width:80; max-width:320px; background:#1f2937; padding:2rem; display:flex; flex-direction:column; gap:1rem; transform:translateX(100%); transition:0.3s; z-index:50; }
    #profile-sidebar.open { transform:translateX(0); }
    #sidebar-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.7); opacity:0; pointer-events:none; transition:0.3s; z-index:40; }
    #sidebar-overlay.visible { opacity:1; pointer-events:auto; }
    #profile-sidebar img { width:112px; height:112px; border-radius:9999px; object-fit:cover; border:4px solid #a78bfa; margin:0 auto; }
    #profile-sidebar h2 { text-align:center; font-size:1.5rem; font-weight:600; }
    #profile-sidebar p { text-align:center; color:#c4b5fd; }

    /* Modal imagen perfil */
    #modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.7); display:none; justify-content:center; align-items:center; z-index:60; }
    #modal-overlay.active { display:flex; }
    #modal { background:#1f2937; border-radius:0.5rem; padding:1.5rem; width:90%; max-width:400px; box-shadow:0 10px 15px rgba(0,0,0,0.5); color:#e0e0e0; }
    #modal input { width:100%; padding:0.5rem; border-radius:0.375rem; border:none; margin-bottom:1rem; font-size:1rem; color:#111827; }
    #modal button { padding:0.5rem 1rem; border-radius:0.375rem; font-weight:600; cursor:pointer; transition:0.2s; margin-right:0.5rem; }
    #modal .btn-cancel { background:#374151; color:white; }
    #modal .btn-save { background:#7c3aed; color:white; }
    #modal .btn-cancel:hover { background:#4b5563; }
    #modal .btn-save:hover { background:#6d28d9; }
    #modal p.error { color:#f87171; font-size:0.875rem; margin-top:0.5rem; }
  </style>
</head>
<body class="flex flex-col">

  <!-- HEADER -->
  <header class="bg-gray-800 p-4 flex items-center justify-between relative z-20">
    <h1 class="text-2xl font-bold text-purple-400">Panel Administrador</h1>
    <div id="profile-container" class="relative cursor-pointer">
      <img id="profile-image" src="https://via.placeholder.com/150?text=Sin+Imagen" alt="Perfil" class="w-16 h-16 rounded-full border-4 border-purple-400" />
    </div>
  </header>

  <!-- DASHBOARD -->
  <main class="flex-grow p-6 max-w-4xl mx-auto w-full">
    <div id="dasha-container">
      <i data-lucide="layout-dashboard"></i>
      <span>
        Total Usuarios: <b id="total-users">0</b>,
        Activos: <b id="active-users">0</b>,
        Inactivos: <b id="inactive-users">0</b>
      </span>
    </div>

    <section class="grid grid-cols-2 md:grid-cols-2 gap-6">
      <a href="https://nimeapp.github.io/Flixplemusic/editar.html" class="dashboard-card"><i data-lucide="edit-2"></i><span>Editar Perfil</span></a>
      <a href="https://nimeapp.github.io/Flixplemusic/generadorMusica.html" class="dashboard-card"><i data-lucide="music"></i><span>Generador Música</span></a>
      <a href="https://nimeapp.github.io/Flixplemusic/generadorfeed.html" class="dashboard-card"><i data-lucide="rss"></i><span>Generador Feed</span></a>
      <a href="https://nimeapp.github.io/Flixplemusic/eliminar.html" class="dashboard-card"><i data-lucide="trash-2"></i><span>Eliminar Canciones</span></a>
    </section>
  </main>

  <!-- SIDEBAR ADMIN -->
  <div id="sidebar-overlay"></div>
  <aside id="profile-sidebar">
    <button id="close-sidebar-btn" class="self-end text-purple-400 hover:text-purple-600"><i data-lucide="x"></i></button>
    <img id="sidebar-profile-image" src="https://via.placeholder.com/150?text=Sin+Imagen" alt="Perfil">
    <h2 id="sidebar-user-name">Nombre</h2>
    <p id="sidebar-user-email">Correo</p>
    <button id="logout-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded mt-auto">Cerrar sesión</button>
  </aside>

  <!-- MODAL EDITAR FOTO -->
  <div id="modal-overlay">
    <div id="modal">
      <h3>Cambiar URL de imagen</h3>
      <input type="url" id="new-image-url" placeholder="Pega aquí la URL de la imagen">
      <p id="modal-error" class="error hidden"></p>
      <div class="flex justify-end">
        <button class="btn-cancel" id="modal-cancel-btn">Cancelar</button>
        <button class="btn-save" id="modal-save-btn">Guardar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getDatabase, ref, get, onValue, update } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDiACaIKPXiSdcBo-bq4BW7z7gjpouVNos",
      authDomain: "flixplemusic.firebaseapp.com",
      databaseURL: "https://flixplemusic-default-rtdb.firebaseio.com",
      projectId: "flixplemusic",
      storageBucket: "flixplemusic.firebasestorage.app",
      messagingSenderId: "792301053512",
      appId: "1:792301053512:web:13878703d081f1a7b3da7d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const totalUsersEl = document.getElementById('total-users');
    const activeUsersEl = document.getElementById('active-users');
    const inactiveUsersEl = document.getElementById('inactive-users');
    const profileImage = document.getElementById('profile-image');
    const sidebar = document.getElementById('profile-sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const sidebarProfileImage = document.getElementById('sidebar-profile-image');
    const sidebarUserName = document.getElementById('sidebar-user-name');
    const sidebarUserEmail = document.getElementById('sidebar-user-email');
    const profileContainer = document.getElementById('profile-container');
    const logoutBtn = document.getElementById('logout-btn');
    const modalOverlay = document.getElementById('modal-overlay');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');
    const modalSaveBtn = document.getElementById('modal-save-btn');
    const newImageUrlInput = document.getElementById('new-image-url');
    const modalError = document.getElementById('modal-error');

    let currentUser = null;
    let currentUserData = null;

    // Funciones sidebar
    function openSidebar() {
      if(!currentUserData) return;
      sidebarProfileImage.src = currentUserData.profileImage || 'https://via.placeholder.com/150?text=Sin+Imagen';
      sidebarUserName.textContent = currentUserData.name || currentUser.displayName || 'Sin nombre';
      sidebarUserEmail.textContent = currentUserData.email || currentUser.email || 'Sin correo';
      sidebar.classList.add('open');
      sidebarOverlay.classList.add('visible');
    }
    function closeSidebar() {
      sidebar.classList.remove('open');
      sidebarOverlay.classList.remove('visible');
    }
    profileContainer.addEventListener('click', openSidebar);
    sidebarOverlay.addEventListener('click', closeSidebar);
    document.getElementById('close-sidebar-btn').addEventListener('click', closeSidebar);

    // Modal cambiar imagen
    profileImage.addEventListener('click', ()=>{
      newImageUrlInput.value = currentUserData?.profileImage || '';
      modalError.classList.add('hidden');
      modalOverlay.classList.add('active');
      newImageUrlInput.focus();
    });
    modalCancelBtn.addEventListener('click', ()=>modalOverlay.classList.remove('active'));
    modalOverlay.addEventListener('click', e=>{ if(e.target===modalOverlay) modalOverlay.classList.remove('active'); });

    function isValidUrl(string){ try{ new URL(string); return true;} catch{return false;} }
    function hasValidImageExtension(url){ return /\.(png|jpe?g|gif)$/i.test(url.trim()); }

    modalSaveBtn.addEventListener('click', async ()=>{
      const newUrl = newImageUrlInput.value.trim();
      if(!newUrl){ modalError.textContent='Ingresa una URL'; modalError.classList.remove('hidden'); return;}
      if(!isValidUrl(newUrl)){ modalError.textContent='URL inválida'; modalError.classList.remove('hidden'); return;}
      if(!hasValidImageExtension(newUrl)){ modalError.textContent='Debe terminar en .png, .jpg o .gif'; modalError.classList.remove('hidden'); return;}
      try{
        await update(ref(db,'admins/'+currentUser.uid),{profileImage:newUrl});
        currentUserData.profileImage = newUrl;
        profileImage.src = newUrl;
        sidebarProfileImage.src = newUrl;
        modalOverlay.classList.remove('active');
      }catch(e){ modalError.textContent='Error al actualizar: '+e.message; modalError.classList.remove('hidden'); }
    });

    // Autenticación y datos admin
    onAuthStateChanged(auth, async (user)=>{
      if(user){
        currentUser = user;
        try{
          const snapshot = await get(ref(db,'admins/'+user.uid));
          if(snapshot.exists()){ currentUserData = snapshot.val(); profileImage.src=currentUserData.profileImage||'https://via.placeholder.com/150?text=Sin+Imagen'; }
          else{ currentUserData={name:user.displayName,email:user.email,profileImage:'https://via.placeholder.com/150?text=Sin+Imagen'}; profileImage.src=currentUserData.profileImage; }
        }catch(e){ console.error(e); currentUserData={name:user.displayName,email:user.email,profileImage:'https://via.placeholder.com/150?text=Sin+Imagen'}; }
      }else{ window.location.href='login.html'; }
    });

    logoutBtn.addEventListener('click', async ()=>{ await signOut(auth); window.location.href='login.html'; });

    // Contador usuarios
    const counterRef = ref(db,'counters/users');
    get(counterRef).then(snapshot=>{
      totalUsersEl.textContent = snapshot.val() || 0;
    }).catch(()=>{ totalUsersEl.textContent=0; });

    // Usuarios activos e inactivos
    const usersRef = ref(db,'users');
    onValue(usersRef,(snapshot)=>{
      const users = snapshot.val()||{};
      let active=0, inactive=0;
      const now = new Date();
      Object.values(users).forEach(u=>{
        const lastLogin = new Date(u.lastLogin||u.createdAt||now);
        const diffHours = (now-lastLogin)/(1000*60*60);
        if(diffHours<=24) active++; else inactive++;
      });
      activeUsersEl.textContent = active;
      inactiveUsersEl.textContent = inactive;
    });

    lucide.createIcons();
  </script>
</body>
</html>
