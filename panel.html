<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Administrador</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body { background-color:#111827; color:#e0e0e0; min-height:100vh; }

    #dasha-container {
      width:100%;
      background:#1f2937;
      color:#e0e0e0;
      padding:1rem 1.5rem;
      border-radius:0.75rem;
      display:flex;
      align-items:center;
      gap:1rem;
      margin-bottom:1.5rem;
      user-select:none;
      flex-wrap:wrap;
    }

    .dashboard-card {
      background:#1f2937;
      border-radius:0.75rem;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:2rem;
      gap:1rem;
      aspect-ratio:1/1;
      transition:transform 0.2s, background 0.2s, box-shadow 0.2s;
      cursor:pointer;
      box-shadow:0 4px 8px rgba(0,0,0,0.3);
    }

    .dashboard-card:hover {
      background:#7c3aed;
      transform:translateY(-4px);
      box-shadow:0 8px 16px rgba(0,0,0,0.4);
    }

    .dashboard-card i { width:48px; height:48px; }
    .dashboard-card span { font-size:1.125rem; font-weight:600; text-align:center; color:#e0e0e0; }

    /* Sidebar */
    #profile-sidebar { 
      transition:transform 0.3s ease-in-out; 
      transform:translateX(100%); 
      display:flex; flex-direction:column; justify-content:space-between; 
      position:fixed; top:0; right:0; height:100%; width:80%; max-width:400px; 
      background:#1f2937; padding:2rem; z-index:50; border-left:2px solid #7c3aed;
    }
    #profile-sidebar.open { transform:translateX(0); }
    #sidebar-overlay { 
      transition:opacity 0.3s ease-in-out; 
      opacity:0; pointer-events:none; 
      background:rgba(0,0,0,0.7); 
      position:fixed; inset:0; z-index:40; 
    }
    #sidebar-overlay.visible { opacity:1; pointer-events:auto; }

    #profile-sidebar img { border-radius:50%; border:4px solid #7c3aed; width:120px; height:120px; object-fit:cover; margin:0 auto 1rem; }

    #profile-sidebar h2 { text-align:center; font-size:1.5rem; margin-bottom:0.5rem; }
    #profile-sidebar p { text-align:center; margin-bottom:1rem; color:#9d7cd3; }

    #camera-icon {
      width:32px; height:32px; display:flex; align-items:center; justify-content:center; 
      padding:4px; border-radius:50%; background:#7c3aed; position:absolute; bottom:0; right:0; cursor:pointer;
    }

    #modal-overlay {
      position:fixed; inset:0; background:rgba(0,0,0,0.7); display:none; justify-content:center; align-items:center; z-index:60;
    }
    #modal-overlay.active { display:flex; }
    #modal { background:#1f2937; border-radius:0.5rem; padding:1.5rem; width:90%; max-width:400px; color:#e0e0e0; }
    #modal h3 { font-size:1.25rem; margin-bottom:1rem; }
    #modal input[type="url"] { width:100%; padding:0.5rem; border-radius:0.375rem; border:none; margin-bottom:1rem; font-size:1rem; color:#111827; }
    #modal button { background-color:#7c3aed; color:white; padding:0.5rem 1rem; border-radius:0.375rem; font-weight:600; cursor:pointer; margin-right:0.5rem; }
    #modal .btn-cancel { background-color:#374151; }
    #modal .btn-cancel:hover { background-color:#4b5563; }
    #modal p.error { color:#f87171; margin-top:0.5rem; font-size:0.875rem; }

  </style>
</head>
<body class="flex flex-col">

  <!-- HEADER -->
  <header class="bg-gray-800 p-4 flex items-center justify-between relative z-20">
    <h1 class="text-2xl font-bold text-purple-400">Panel Administrador</h1>
    <div id="profile-container" class="relative cursor-pointer">
      <img id="profile-image" src="https://via.placeholder.com/150?text=Sin+Imagen" alt="Perfil" class="rounded-full w-16 h-16 border-4 border-purple-400 object-cover" />
      <div id="camera-icon" title="Editar imagen">
        <i data-lucide="camera" class="text-white"></i>
      </div>
    </div>
  </header>

  <!-- DASHBOARD -->
  <main class="flex-grow p-6 max-w-4xl mx-auto w-full">
    <div id="dasha-container">
      <i data-lucide="layout-dashboard"></i>
      <span>
        Total Usuarios: <b id="total-users">0</b>,
        Activos: <b id="active-users">0</b>,
        Inactivos: <b id="inactive-users">0</b>
      </span>
    </div>

    <section class="grid grid-cols-2 md:grid-cols-2 gap-6">
      <a href="#" class="dashboard-card" title="Editar Perfil"><i data-lucide="edit-2"></i><span>Editar Perfil</span></a>
      <a href="#" class="dashboard-card" title="Generador Música"><i data-lucide="music"></i><span>Generador Música</span></a>
      <a href="#" class="dashboard-card" title="Generador Feed"><i data-lucide="rss"></i><span>Generador Feed</span></a>
      <a href="#" class="dashboard-card" title="Eliminar Canciones"><i data-lucide="trash-2"></i><span>Eliminar Canciones</span></a>
    </section>
  </main>

  <!-- SIDEBAR -->
  <div id="sidebar-overlay"></div>
  <aside id="profile-sidebar">
    <div>
      <button id="close-sidebar-btn" class="self-end mb-6 text-purple-400 hover:text-purple-600">
        <i data-lucide="x" class="w-6 h-6"></i>
      </button>
      <img id="sidebar-profile-image" src="https://via.placeholder.com/150?text=Sin+Imagen" alt="Perfil" />
      <h2 id="sidebar-user-name">Nombre Admin</h2>
      <p id="sidebar-user-email">admin@email.com</p>
      <p>Administrador</p>
    </div>
  </aside>

  <!-- MODAL -->
  <div id="modal-overlay">
    <div id="modal">
      <h3>Cambiar URL de imagen de perfil</h3>
      <input type="url" id="new-image-url" placeholder="Pega aquí la URL de la imagen" />
      <p id="modal-error" class="error hidden"></p>
      <div class="flex justify-end">
        <button class="btn-cancel" id="modal-cancel-btn">Cancelar</button>
        <button id="modal-save-btn">Guardar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getDatabase, ref, get, update, onValue } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDiACaIKPXiSdcBo-bq4BW7z7gjpouVNos",
      authDomain: "flixplemusic.firebaseapp.com",
      databaseURL: "https://flixplemusic-default-rtdb.firebaseio.com",
      projectId: "flixplemusic",
      storageBucket: "flixplemusic.firebasestorage.app",
      messagingSenderId: "792301053512",
      appId: "1:792301053512:web:13878703d081f1a7b3da7d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const totalUsersEl = document.getElementById('total-users');
    const activeUsersEl = document.getElementById('active-users');
    const inactiveUsersEl = document.getElementById('inactive-users');

    const profileImage = document.getElementById('profile-image');
    const cameraIcon = document.getElementById('camera-icon');
    const profileContainer = document.getElementById('profile-container');

    const sidebar = document.getElementById('profile-sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const sidebarProfileImage = document.getElementById('sidebar-profile-image');
    const sidebarUserName = document.getElementById('sidebar-user-name');
    const sidebarUserEmail = document.getElementById('sidebar-user-email');
    const closeSidebarBtn = document.getElementById('close-sidebar-btn');

    const modalOverlay = document.getElementById('modal-overlay');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');
    const modalSaveBtn = document.getElementById('modal-save-btn');
    const newImageUrlInput = document.getElementById('new-image-url');
    const modalError = document.getElementById('modal-error');

    let currentUser = null;
    let currentUserData = null;

    function openSidebar() {
      if (!currentUserData) return;
      sidebarProfileImage.src = currentUserData.profileImage || 'https://via.placeholder.com/150?text=Sin+Imagen';
      sidebarUserName.textContent = currentUserData.name || currentUser.displayName || 'Sin nombre';
      sidebarUserEmail.textContent = currentUserData.email || currentUser.email || 'Sin correo';
      sidebar.classList.add('open');
      sidebarOverlay.classList.add('visible');
      document.body.style.overflow='hidden';
      window.lucide.replace();
    }

    function closeSidebar() {
      sidebar.classList.remove('open');
      sidebarOverlay.classList.remove('visible');
      document.body.style.overflow='';
    }

    profileContainer.addEventListener('click', openSidebar);
    sidebarOverlay.addEventListener('click', closeSidebar);
    closeSidebarBtn.addEventListener('click', closeSidebar);

    cameraIcon.addEventListener('click', e=>{
      e.stopPropagation();
      newImageUrlInput.value = currentUserData?.profileImage || '';
      modalError.classList.add('hidden');
      modalOverlay.classList.add('active');
      newImageUrlInput.focus();
    });

    modalCancelBtn.addEventListener('click', ()=> modalOverlay.classList.remove('active'));
    modalOverlay.addEventListener('click', e=> { if(e.target===modalOverlay) modalOverlay.classList.remove('active'); });

    function isValidUrl(string){ try{ new URL(string); return true;} catch{return false;} }
    function hasValidImageExtension(url){ return /\.(png|jpe?g|gif)$/i.test(url.trim()); }

    modalSaveBtn.addEventListener('click', async ()=>{
      const newUrl = newImageUrlInput.value.trim();
      if(!newUrl){ modalError.textContent='Por favor ingresa una URL.'; modalError.classList.remove('hidden'); return;}
      if(!isValidUrl(newUrl)){ modalError.textContent='La URL no es válida.'; modalError.classList.remove('hidden'); return;}
      if(!hasValidImageExtension(newUrl)){ modalError.textContent='La URL debe terminar en .png, .jpg, .jpeg o .gif'; modalError.classList.remove('hidden'); return;}
      modalError.classList.add('hidden');
      try{
        await update(ref(db,'admins/'+currentUser.uid),{profileImage:newUrl});
        currentUserData.profileImage = newUrl;
        profileImage.src = newUrl;
        sidebarProfileImage.src = newUrl;
        modalOverlay.classList.remove('active');
      }catch(e){ modalError.textContent='Error al actualizar imagen: '+e.message; modalError.classList.remove('hidden'); }
    });

    onAuthStateChanged(auth, async user=>{
      if(user){
        currentUser = user;
        try{
          const snapshot = await get(ref(db,'admins/'+user.uid));
          if(snapshot.exists()){ currentUserData = snapshot.val(); profileImage.src=currentUserData.profileImage||'https://via.placeholder.com/150?text=Sin+Imagen'; }
          else{ currentUserData={name:user.displayName,email:user.email,profileImage:'https://via.placeholder.com/150?text=Sin+Imagen'}; profileImage.src=currentUserData.profileImage; }
        }catch(e){ currentUserData={name:user.displayName,email:user.email,profileImage:'https://via.placeholder.com/150?text=Sin+Imagen'}; profileImage.src=currentUserData.profileImage; }
      }else{ window.location.href='https://nimeapp.github.io/Flixplemusic/login.html'; }
      window.lucide.replace();
    });

    // Contador de usuarios
    const counterRef = ref(db,'counters/users');
    get(counterRef).then(snapshot=>{
      const counterValue = snapshot.val()||0;
      totalUsersEl.textContent = counterValue;
    }).catch(err=>{ totalUsersEl.textContent = 0; console.error(err); });

    const usersRef = ref(db,'users');
    onValue(usersRef,snapshot=>{
      const users = snapshot.val()||{};
      let active=0, inactive=0;
      const now = new Date();
      Object.values(users).forEach(u=>{
        const lastLogin = new Date(u.lastLogin||u.createdAt||now);
        const diffHours = (now-lastLogin)/(1000*60*60);
        if(diffHours<=24) active++; else inactive++;
      });
      activeUsersEl.textContent = active;
      inactiveUsersEl.textContent = inactive;
    });

    lucide.createIcons();
  </script>

</body>
</html>
