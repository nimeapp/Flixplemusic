<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Generador de Playlists y Tracks</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<style>
* { -webkit-user-select: none; -webkit-touch-callout: none; }
#individualUrlsContainer { margin-top: 1rem; max-width: 100%; background-color: #1f2937; padding: 0.75rem; border-radius: 0.5rem; font-family: monospace; font-size: 0.875rem; color: #9ee6a8; overflow-wrap: break-word; }
#duplicateModal { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.5); z-index: 50; opacity: 0; pointer-events: none; transition: opacity 0.4s ease; }
#duplicateModal.show { opacity: 1; pointer-events: auto; }
#duplicateModalContent { background-color: #8b5cf6; border: 4px solid #7ee787; border-radius: 1rem; padding: 1.5rem 2rem; color: #fff; font-weight: bold; font-size: 1.2rem; text-align: center; box-shadow: 0 0 20px #7ee787; transform: scale(0.8); transition: transform 0.4s ease; }
#duplicateModal.show #duplicateModalContent { transform: scale(1); }
</style>
</head>
<body class="bg-gradient-to-b from-[#2d1600] to-black text-white min-h-screen flex flex-col items-center p-4">

<div class="w-full max-w-3xl">
  <h1 class="text-3xl font-bold mb-6 text-center">Buscador y Reproductor de Música</h1>
  <div class="mb-6 max-w-sm mx-auto">
    <input id="searchInput" type="text" placeholder="Escribe un artista (ej: Shakira)" class="w-full p-3 rounded-lg text-black" />
    <button id="searchBtn" class="w-full mt-3 bg-green-500 hover:bg-green-600 text-black font-semibold py-2 rounded-lg">Buscar</button>
  </div>
  <div id="albumsContainer" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8"></div>
  <div id="tracksSection" class="hidden mb-8">
    <h2 class="text-2xl font-semibold mb-4 text-center">Canciones del Álbum</h2>
    <div id="tracksContainer" class="space-y-3 max-h-[400px] overflow-y-auto bg-gray-800 p-4 rounded-lg"></div>
    <button id="saveAlbumBtn" disabled class="mt-4 w-full bg-green-600 hover:bg-green-700 text-black font-semibold py-2 rounded-lg">Guardar álbum en playlist y cargar para reproducir</button>
  </div>
  <div id="generatedContainer" class="hidden mt-4 flex flex-col items-center justify-center gap-3">
    <div id="generatedUrlContainer" class="max-w-full bg-gray-900 p-3 rounded-lg break-words text-green-400 font-mono text-sm"></div>
    <div id="individualUrlsContainer" class="max-w-full hidden"></div>
  </div>
</div>

<div id="duplicateModal">
  <div id="duplicateModalContent"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
import { getDatabase, ref, push, set, get } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDiACaIKPXiSdcBo-bq4BW7z7gjpouVNos",
  authDomain: "flixplemusic.firebaseapp.com",
  databaseURL: "https://flixplemusic-default-rtdb.firebaseio.com",
  projectId: "flixplemusic",
  storageBucket: "flixplemusic.appspot.com",
  messagingSenderId: "792301053512",
  appId: "1:792301053512:web:13878703d081f1a7b3da7d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const albumsContainer = document.getElementById('albumsContainer');
const tracksSection = document.getElementById('tracksSection');
const tracksContainer = document.getElementById('tracksContainer');
const saveAlbumBtn = document.getElementById('saveAlbumBtn');
const generatedContainer = document.getElementById('generatedContainer');
const generatedUrlContainer = document.getElementById('generatedUrlContainer');
const individualUrlsContainer = document.getElementById('individualUrlsContainer');
const duplicateModal = document.getElementById('duplicateModal');
const duplicateModalContent = document.getElementById('duplicateModalContent');

let playlist = [], currentAlbumTitle = "", currentArtist = "", currentAlbumCover = "";
let isAdmin = false;

onAuthStateChanged(auth, async (user) => {
  if(user){
    const snapshot = await get(ref(db, `admins/${user.uid}`));
    isAdmin = snapshot.exists() && snapshot.val().role==="admin";
    saveAlbumBtn.disabled = !isAdmin;
  } else { isAdmin = false; saveAlbumBtn.disabled = true; }
});

function showDuplicateModal(message){
  duplicateModalContent.textContent = message;
  duplicateModal.classList.add('show');
  setTimeout(()=>duplicateModal.classList.remove('show'), 5000);
  duplicateModal.onclick = ()=>duplicateModal.classList.remove('show');
}

// Guardar playlist y tracks
saveAlbumBtn.onclick = async () => {
  if(!isAdmin){ alert("No tienes permisos para guardar."); return; }

  // Construir playlist desde inputs
  playlist = [];
  for(const div of tracksContainer.children){
    const title = div.children[0].textContent;
    const url = (div.children[1].value||'').trim();
    if(url) playlist.push({ title, artist: currentArtist, url, cover: currentAlbumCover });
  }
  if(!playlist.length){ alert("Ingresa al menos una URL válida."); return; }

  try {
    // Revisar duplicados
    const playlistsSnapshot = await get(ref(db,'playlists'));
    const allPlaylists = playlistsSnapshot.exists()? playlistsSnapshot.val() : {};
    const exists = Object.values(allPlaylists).some(p=>p.album===currentAlbumTitle && p.artist===currentArtist);
    if(exists){ showDuplicateModal(`El álbum "${currentAlbumTitle}" de ${currentArtist} ya existe.`); return; }

    // Guardar playlist principal
    const pr = push(ref(db,'playlists'));
    const playlistId = pr.key;
    await set(pr, { createdAt: new Date().toISOString(), playlist, album: currentAlbumTitle, artist: currentArtist, cover: currentAlbumCover });

    // Guardar tracks individuales y generar URLs
    const tracksSnapshot = await get(ref(db,'tracks'));
    const existingTracks = tracksSnapshot.exists()? tracksSnapshot.val() : {};
    const individualUrls = [];
    for(const track of playlist){
      const trackExists = Object.entries(existingTracks).some(([k,t])=>t.title===track.title && t.artist===track.artist);
      if(trackExists){
        const existingTrackId = Object.entries(existingTracks).find(([k,t])=>t.title===track.title && t.artist===track.artist)[0];
        individualUrls.push(`${location.origin}/Flixplemusic/reproductor2.html?track=${existingTrackId}`);
        continue;
      }
      const trackRef = push(ref(db,'tracks')); 
      const trackId = trackRef.key;
      await set(trackRef,{ title: track.title, artist: track.artist, url: track.url, cover: track.cover, album: currentAlbumTitle, createdAt: new Date().toISOString(), playlistId });
      individualUrls.push(`${location.origin}/Flixplemusic/reproductor2.html?track=${trackId}`);
    }

    // Mostrar URLs generadas
    const link = `${location.origin}/Flixplemusic/Reproductor.html?playlist=${playlistId}`;
    generatedUrlContainer.textContent = `Playlist URL: ${link}`;
    individualUrlsContainer.innerHTML = '<strong>URLs individuales:</strong><br>' + individualUrls.map(u=>`<a href="${u}" target="_blank" class="underline text-green-300">${u}</a>`).join('<br>');
    individualUrlsContainer.classList.remove('hidden');
    generatedContainer.classList.remove('hidden');

    alert("Se guardó el álbum y los tracks individuales con éxito");

  } catch(err){ console.error(err); alert("Error al guardar: " + err.message); }
};
</script>
</body>
</html>
