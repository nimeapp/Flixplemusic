<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Generador y Reproductor de Música</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    * { -webkit-user-select: none; -webkit-touch-callout: none; }

    .track-item {
      cursor: pointer;
      padding: 0.5rem 0.25rem;
      border-radius: 0.375rem;
      transition: background-color 0.3s, color 0.3s;
    }
    .track-item:hover { background-color: #2d1600; }
    .track-item.active { color: #a3f7bf; font-weight: 600; background-color: #1a3a27; }

    #individualUrlsContainer {
      margin-top: 1rem;
      max-width: 100%;
      background-color: #1f2937;
      padding: 0.75rem;
      border-radius: 0.5rem;
      font-family: monospace;
      font-size: 0.875rem;
      color: #9ee6a8;
      overflow-wrap: break-word;
    }

    /* Modal animado */
    #duplicateModal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: rgba(0,0,0,0.5);
      z-index: 50;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
    }
    #duplicateModal.show {
      opacity: 1;
      pointer-events: auto;
    }
    #duplicateModalContent {
      background-color: #8b5cf6; /* morado brillante */
      border: 4px solid #7ee787; /* verde claro */
      border-radius: 1rem;
      padding: 1.5rem 2rem;
      color: #fff;
      font-weight: bold;
      font-size: 1.2rem;
      text-align: center;
      box-shadow: 0 0 20px #7ee787;
      transform: scale(0.8);
      transition: transform 0.4s ease;
    }
    #duplicateModal.show #duplicateModalContent {
      transform: scale(1);
    }
  </style>
</head>
<body class="bg-gradient-to-b from-[#2d1600] to-black text-white min-h-screen flex flex-col items-center p-4">

  <!-- Contenido principal (igual que tu HTML anterior) -->
  <div class="w-full max-w-3xl">
    <h1 class="text-3xl font-bold mb-6 text-center">Buscador y Reproductor de Música</h1>
    <div class="mb-6 max-w-sm mx-auto">
      <input id="searchInput" type="text" placeholder="Escribe un artista (ej: Shakira)" class="w-full p-3 rounded-lg text-black" />
      <button id="searchBtn" class="w-full mt-3 bg-green-500 hover:bg-green-600 text-black font-semibold py-2 rounded-lg">Buscar</button>
    </div>
    <div id="albumsContainer" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8"></div>
    <div id="tracksSection" class="hidden mb-8">
      <h2 class="text-2xl font-semibold mb-4 text-center">Canciones del Álbum</h2>
      <div id="tracksContainer" class="space-y-3 max-h-[400px] overflow-y-auto bg-gray-800 p-4 rounded-lg"></div>
      <button id="saveAlbumBtn" disabled class="mt-4 w-full bg-green-600 hover:bg-green-700 text-black font-semibold py-2 rounded-lg">Guardar álbum en playlist y cargar para reproducir</button>
    </div>
    <div id="generatedContainer" class="hidden mt-4 flex flex-col items-center justify-center gap-3">
      <div id="generatedUrlContainer" class="max-w-full bg-gray-900 p-3 rounded-lg break-words text-green-400 font-mono text-sm"></div>
      <div id="individualUrlsContainer" class="max-w-full hidden"></div>
      <div class="flex items-center gap-3">
        <button id="copyBtn" class="inline-flex items-center gap-2 bg-gray-800 hover:bg-gray-700 text-gray-200 px-4 py-2 rounded-lg">
          <i class="fa-solid fa-copy"></i><span id="copyBtnText">Copiar todo</span>
        </button>
      </div>
      <span id="copyMsg" class="hidden text-sm text-green-400 font-medium">¡Copiado!</span>
    </div>
    <!-- Reproductor igual que tu HTML anterior -->
    <div class="w-full max-w-sm mx-auto bg-gradient-to-b from-[#2d1600] to-black p-6 rounded-xl shadow-lg mt-12">
      <div class="flex justify-center mb-6">
        <img id="albumCover" src="https://via.placeholder.com/300" alt="Imagen del álbum" class="rounded-xl w-full max-w-xs shadow-lg" />
      </div>
      <div class="text-center mb-2">
        <h2 id="trackTitle" class="text-lg font-semibold">Título</h2>
        <p id="trackArtist" class="text-sm text-gray-400">Artista</p>
      </div>
      <audio id="audio" src=""></audio>
      <div class="mt-4">
        <input type="range" id="progress" value="0" class="w-full accent-green-500" />
        <div class="flex justify-between text-xs text-gray-400 mt-1">
          <span id="current">0:00</span>
          <span id="total">0:00</span>
        </div>
      </div>
      <div class="flex justify-between items-center mt-4 px-6 text-2xl text-white">
        <button id="shuffleBtn" class="opacity-60 hover:opacity-100"><i class="fa-solid fa-shuffle"></i></button>
        <button id="back"><i class="fa-solid fa-backward-step"></i></button>
        <button id="playBtn" class="bg-white text-black w-14 h-14 rounded-full flex items-center justify-center shadow-lg">
          <i class="fa-solid fa-play" id="playIcon"></i>
        </button>
        <button id="next"><i class="fa-solid fa-forward-step"></i></button>
        <button id="repeatBtn" class="opacity-60 hover:opacity-100"><i class="fa-solid fa-repeat"></i></button>
      </div>
      <div id="playlistContainer" class="mt-6 max-h-60 overflow-y-auto text-left px-2"></div>
    </div>
  </div>

  <!-- Modal duplicado -->
  <div id="duplicateModal">
    <div id="duplicateModalContent"></div>
  </div>

  <!-- Firebase y lógica -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import { getDatabase, ref, push, set, get } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDiACaIKPXiSdcBo-bq4BW7z7gjpouVNos",
      authDomain: "flixplemusic.firebaseapp.com",
      databaseURL: "https://flixplemusic-default-rtdb.firebaseio.com",
      projectId: "flixplemusic",
      storageBucket: "flixplemusic.appspot.com",
      messagingSenderId: "792301053512",
      appId: "1:792301053512:web:13878703d081f1a7b3da7d"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const albumsContainer = document.getElementById('albumsContainer');
    const tracksSection = document.getElementById('tracksSection');
    const tracksContainer = document.getElementById('tracksContainer');
    const saveAlbumBtn = document.getElementById('saveAlbumBtn');
    const generatedContainer = document.getElementById('generatedContainer');
    const generatedUrlContainer = document.getElementById('generatedUrlContainer');
    const individualUrlsContainer = document.getElementById('individualUrlsContainer');
    const copyBtn = document.getElementById('copyBtn');
    const copyMsg = document.getElementById('copyMsg');
    const audio = document.getElementById('audio');
    const playBtn = document.getElementById('playBtn');
    const playIcon = document.getElementById('playIcon');
    const progress = document.getElementById('progress');
    const current = document.getElementById('current');
    const total = document.getElementById('total');
    const repeatBtn = document.getElementById('repeatBtn');
    const shuffleBtn = document.getElementById('shuffleBtn');
    const backBtn = document.getElementById('back');
    const nextBtn = document.getElementById('next');
    const albumCoverImg = document.getElementById('albumCover');
    const trackTitleElem = document.getElementById('trackTitle');
    const trackArtistElem = document.getElementById('trackArtist');
    const playlistContainer = document.getElementById('playlistContainer');

    const duplicateModal = document.getElementById('duplicateModal');
    const duplicateModalContent = document.getElementById('duplicateModalContent');

    let playlist = [], currentTrackIndex = 0;
    let isRepeat = false, isShuffle = false;
    let currentAlbumTitle = "", currentArtist = "", currentAlbumCover = "";
    let isAdmin = false;

    onAuthStateChanged(auth, async (user) => {
      if(user){
        const snapshot = await get(ref(db, `admins/${user.uid}`));
        isAdmin = snapshot.exists() && snapshot.val().role==="admin";
        saveAlbumBtn.disabled = !isAdmin;
      } else { isAdmin = false; saveAlbumBtn.disabled = true; }
    });

    function jsonp(url){
      return new Promise((resolve,reject)=>{
        const cb='cb_'+Math.random().toString(36).substring(2,9);
        const script=document.createElement('script');
        window[cb]=data=>{ delete window[cb]; if(script.parentNode)script.parentNode.removeChild(script); resolve(data); };
        script.onerror = ()=>{ delete window[cb]; if(script.parentNode)script.parentNode.removeChild(script); reject(new Error('JSONP error')); };
        script.src=`${url}&output=jsonp&callback=${cb}`;
        document.body.appendChild(script);
      });
    }

    async function searchArtist(){
      const q=searchInput.value.trim(); if(!q)return alert("Escribe un artista");
      albumsContainer.innerHTML='Buscando...';
      tracksSection.classList.add('hidden'); generatedContainer.classList.add('hidden'); saveAlbumBtn.disabled=true;
      try{
        const d=await jsonp(`https://api.deezer.com/search/artist?q=${encodeURIComponent(q)}`);
        const artist=d.data?.[0]; if(!artist){ albumsContainer.innerHTML='<p class="text-red-500 text-center">Artista no encontrado</p>'; return; }
        const ad=await jsonp(`https://api.deezer.com/artist/${artist.id}/albums?limit=20`);
        renderAlbums(ad.data);
      } catch(err){ console.error(err); albumsContainer.innerHTML='<p class="text-red-500 text-center">Error al buscar</p>'; }
    }

    function renderAlbums(albums){
      albumsContainer.innerHTML='';
      if(!Array.isArray(albums)||!albums.length){ albumsContainer.innerHTML='<p class="text-yellow-400 text-center">No se encontraron álbumes</p>'; return; }
      albums.forEach(a=>{
        const div=document.createElement('div');
        div.className='bg-gray-800 p-3 rounded cursor-pointer flex flex-col items-center hover:bg-gray-700';
        div.innerHTML=`<img src="${a.cover_medium}" class="w-32 h-32 rounded mb-2"/><h3 class="text-center font-semibold">${a.title}</h3>`;
        div.onclick=()=>loadTracks(a.id,a.cover_big,a.title);
        albumsContainer.appendChild(div);
      });
    }

    async function loadTracks(albumId,coverUrl,albumTitle){
      tracksContainer.innerHTML='Cargando canciones...'; tracksSection.classList.remove('hidden'); generatedContainer.classList.add('hidden'); saveAlbumBtn.disabled=true;
      currentAlbumTitle=albumTitle||''; currentAlbumCover=coverUrl||'https://via.placeholder.com/300'; albumCoverImg.src=currentAlbumCover;
      try{
        const d=await jsonp(`https://api.deezer.com/album/${albumId}`);
        tracksContainer.innerHTML=''; currentArtist=d.artist?.name||'';
        if(!d.tracks?.data?.length){ tracksContainer.innerHTML='<p class="text-red-500 text-center">No se encontraron canciones</p>'; return; }
        d.tracks.data.forEach(t=>{
          const div=document.createElement('div'); div.className='bg-gray-700 p-2 rounded flex justify-between items-center';
          const titleDiv=document.createElement('div'); titleDiv.textContent=t.title; titleDiv.className='truncate max-w-[40%]';
          const input=document.createElement('input'); input.type='url'; input.placeholder=`URL MP3 para "${t.title}"`; input.className='w-2/3 p-1 rounded text-black';
          div.appendChild(titleDiv); div.appendChild(input); tracksContainer.appendChild(div);
        });
        saveAlbumBtn.disabled=!isAdmin;
      } catch(err){ console.error(err); tracksContainer.innerHTML='<p class="text-red-500 text-center">Error al cargar canciones</p>'; }
    }

    function showDuplicateModal(message){
      duplicateModalContent.textContent=message;
      duplicateModal.classList.add('show');
      setTimeout(()=>duplicateModal.classList.remove('show'),5000);
      duplicateModal.onclick=()=>duplicateModal.classList.remove('show');
    }

    saveAlbumBtn.onclick=async()=>{
      if(!isAdmin){ alert("No tienes permisos para guardar."); return; }
      playlist=[]; for(const div of tracksContainer.children){ const title=div.children[0].textContent; const url=(div.children[1].value||'').trim(); if(url) playlist.push({title,artist:currentArtist,url,cover:currentAlbumCover}); }
      if(!playlist.length)return alert("Ingresa al menos una URL válida.");

      try{
        // 1️⃣ Verificar duplicados
        const playlistsSnapshot=await get(ref(db,'playlists')); const allPlaylists=playlistsSnapshot.exists()?playlistsSnapshot.val():{};
        const exists=Object.values(allPlaylists).some(p=>p.album===currentAlbumTitle && p.artist===currentArtist);
        if(exists){ showDuplicateModal(`El álbum "${currentAlbumTitle}" de ${currentArtist} ya existe.`); return; }

        // Guardar playlist
        const pr=push(ref(db,'playlists')); const playlistId=pr.key;
        await set(pr,{createdAt:new Date().toISOString(),playlist,album:currentAlbumTitle,artist:currentArtist,cover:currentAlbumCover});

        // Guardar tracks individuales
        const tracksSnapshot=await get(ref(db,'tracks')); const existingTracks=tracksSnapshot.exists()?tracksSnapshot.val():{};
        const individualUrls=[];
        for(const track of playlist){
          const trackExists=Object.values(existingTracks).some(t=>t.title===track.title && t.artist===track.artist);
          if(trackExists){ const existingTrackId=Object.keys(existingTracks).find(k=>existingTracks[k].title===track.title && existingTracks[k].artist===track.artist); individualUrls.push(`${location.origin}/Flixplemusic/reproductor2.html?track=${existingTrackId}`); continue; }
          const trackRef=push(ref(db,'tracks')); const trackId=trackRef.key;
          await set(trackRef,{title:track.title,artist:track.artist,url:track.url,cover:track.cover,album:currentAlbumTitle,createdAt:new Date().toISOString(),playlistId});
          individualUrls.push(`${location.origin}/Flixplemusic/reproductor2.html?track=${trackId}`);
        }

        const link=`${location.origin}/Flixplemusic/Reproductor.html?playlist=${playlistId}`;
        generatedUrlContainer.textContent=link;
        individualUrlsContainer.innerHTML='<strong>URLs individuales para cada canción:</strong><br>'+individualUrls.map(u=>`<a href="${u}" target="_blank" class="underline text-green-300">${u}</a>`).join('<br>');
        individualUrlsContainer.classList.remove('hidden'); generatedContainer.classList.remove('hidden');
        alert("Se guardó el álbum con éxito");

      }catch(err){ console.error(err); alert("Error al guardar: "+(err.message||err)); }
    };

    searchBtn.onclick=searchArtist;
  </script>
</body>
</html>
