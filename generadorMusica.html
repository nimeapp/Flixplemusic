<!DOCTYPE html>
          if (!playlist.length) return alert("Ingresa al menos una URL válida.");

          currentTrackIndex = 0;
          playTrack(0);

          // Guardar en Firebase y generar URL que apunta a Reproductor.html?id=...
          try {
            const pr = window.fbPush(window.fbRef(window.db, 'playlists'));
            const id = pr.key;
            await window.fbSet(pr, { createdAt: new Date().toISOString(), playlist });
            const link = `${location.origin}/Flixplemusic/Reproductor.html?id=${id}`;
            generatedUrlContainer.textContent = link;
            generatedUrlContainer.classList.remove('hidden');
            generatedUrlContainer.scrollIntoView({ behavior: 'smooth' });
          } catch (err) {
            alert("Error al guardar: " + err.message);
          }
        };
      } catch {
        tracksContainer.innerHTML = '<p class="text-red-500 text-center">Error al cargar canciones</p>';
      }
    }

    function playTrack(idx) {
      if (idx < 0 || idx >= playlist.length) return;
      currentTrackIndex = idx;
      const t = playlist[idx];
      albumCoverImg.src = t.cover;
      trackTitleElem.textContent = t.title;
      trackArtistElem.textContent = t.artist;
      audio.src = t.url;
      audio.play();
      playIcon.classList.replace('fa-play', 'fa-pause');
    }

    function resetPlayer() {
      albumCoverImg.src = 'https://via.placeholder.com/300';
      trackTitleElem.textContent = 'Título';
      trackArtistElem.textContent = 'Artista';
      audio.src = '';
      playIcon.classList.replace('fa-pause', 'fa-play');
      progress.value = 0;
      current.textContent = '0:00';
      total.textContent = '0:00';
    }

    audio.addEventListener('loadedmetadata', () => {
      total.textContent = formatTime(audio.duration);
    });
    audio.addEventListener('timeupdate', () => {
      if (audio.duration) {
        progress.value = (audio.currentTime / audio.duration) * 100;
        current.textContent = formatTime(audio.currentTime);
      }
    });
    progress.addEventListener('input', () => {
      if (audio.duration) audio.currentTime = (progress.value / 100) * audio.duration;
    });
    playBtn.addEventListener('click', () => {
      if (audio.paused) {
        audio.play();
        playIcon.classList.replace('fa-play', 'fa-pause');
      } else {
        audio.pause();
        playIcon.classList.replace('fa-pause', 'fa-play');
      }
    });
    repeatBtn.addEventListener('click', () => {
      isRepeat = !isRepeat;
      audio.loop = isRepeat;
      repeatBtn.classList.toggle('text-green-500', isRepeat);
    });
    shuffleBtn.addEventListener('click', () => {
      isShuffle = !isShuffle;
      shuffleBtn.classList.toggle('text-green-500', isShuffle);
      alert("Modo aleatorio " + (isShuffle ? "activado" : "desactivado"));
    });
    nextBtn.addEventListener('click', () => {
      if (!playlist.length) return;
      if (isShuffle) playTrack(Math.floor(Math.random() * playlist.length));
      else if (currentTrackIndex + 1 < playlist.length) playTrack(currentTrackIndex + 1);
      else if (isRepeat) playTrack(0);
    });
    backBtn.addEventListener('click', () => {
      if (!playlist.length) return;
      if (isShuffle) playTrack(Math.floor(Math.random() * playlist.length));
      else if (currentTrackIndex - 1 >= 0) playTrack(currentTrackIndex - 1);
      else if (isRepeat) playTrack(playlist.length - 1);
    });
    audio.addEventListener('ended', () => {
      if (isRepeat) {
        audio.currentTime = 0;
        audio.play();
      } else nextBtn.click();
    });

    searchBtn.addEventListener('click', searchArtist);
    searchInput.addEventListener('keyup', e => {
      if (e.key === 'Enter') searchArtist();
    });

    // Al cargar la página: desde firebase 
    window.addEventListener('DOMContentLoaded', async () => {
      const params = new URLSearchParams(location.search);
      const pid = params.get('id');
      if (pid) {
        try {
          const dataSnap = await window.fbGet(window.fbChild(window.fbRef(window.db), `playlists/${pid}`));
          if (dataSnap.exists()) {
            playlist = dataSnap.val().playlist;
            currentTrackIndex = 0;
            playTrack(0);
            generatedUrlContainer.textContent = location.href;
            generatedUrlContainer.classList.remove('hidden');
          } else {
            alert("Playlist no encontrada.");
          }
        } catch (e) {
          console.error("Error al cargar playlist:", e);
        }
      }
    });
// Bloquear clic derecho
  document.addEventListener('contextmenu', function (e) {
    e.preventDefault();
  });

  </script>
</body>
</html>
