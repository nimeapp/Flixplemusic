<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reproductor de Playlist</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body {
      background: linear-gradient(to bottom, #2d1600, black);
      color: white;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
      font-family: system-ui, sans-serif;
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
    }
    #playlistContainer { max-height: 240px; overflow-y: auto; margin-top: 1rem; width: 100%; max-width: 400px; padding: 0 0.5rem; }
    .track-item { cursor: pointer; padding: 0.5rem 0.75rem; border-radius: 0.375rem; transition: background-color 0.3s, color 0.3s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .track-item:hover { background-color: #2d1600; }
    .track-item.active { color: #a3f7bf; font-weight: 600; background-color: #1a3a27; }

    #artistAlbums, #randomAlbums { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
    .album-item { cursor: pointer; border-radius: 0.5rem; overflow: hidden; box-shadow: 0 4px 8px rgb(0 0 0 / 0.5); transition: transform 0.3s ease; background-color: #1f2937; }
    .album-item:hover { transform: scale(1.05); }
    .album-item img { width: 100%; display: block; border-bottom: 1px solid #334155; }
    .album-item p { margin: 0.5rem; text-align: center; color: #a3f7bf; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    #randomAlbumsContainer { max-w-md; width: 100%; margin-top: 2rem; padding: 1rem; background-color: #27272a; border-radius: 1rem; box-shadow: 0 4px 12px rgb(0 0 0 / 0.7); color: white; max-width: 400px; }
    * { -webkit-user-select: none; -webkit-touch-callout: none; }

    #listeners { display: flex; justify-content: center; align-items: center; gap: 0.25rem; font-size: 0.875rem; color: #a3f7bf; margin-top: 0.25rem; }
  </style>
</head>
<body>
<div class="bg-gray-900 p-6 rounded-xl shadow-lg w-full max-w-md">
  <div class="flex justify-center mb-6">
    <img id="albumCover" src="https://via.placeholder.com/300" alt="Imagen del álbum" class="rounded-xl w-full max-w-xs shadow-lg" />
  </div>
  <div class="text-center mb-1">
    <h2 id="trackTitle" class="text-lg font-semibold">Título</h2>
    <p id="trackArtist" class="text-sm text-gray-400">Artista</p>
    <div id="listeners"><i class="fa-solid fa-users"></i><span id="listenersCount">0</span> oyentes</div>
  </div>
  <audio id="audio" src=""></audio>
  <div class="mt-4">
    <input type="range" id="progress" value="0" class="w-full accent-green-500" />
    <div class="flex justify-between text-xs text-gray-400 mt-1">
      <span id="current">0:00</span>
      <span id="total">0:00</span>
    </div>
  </div>
  <div class="flex justify-between items-center mt-4 px-6 text-2xl text-white">
    <button id="shuffleBtn" class="opacity-60 hover:opacity-100"><i class="fa-solid fa-shuffle"></i></button>
    <button id="back"><i class="fa-solid fa-backward-step"></i></button>
    <button id="playBtn" class="bg-white text-black w-14 h-14 rounded-full flex items-center justify-center shadow-lg">
      <i class="fa-solid fa-play" id="playIcon"></i>
    </button>
    <button id="next"><i class="fa-solid fa-forward-step"></i></button>
    <button id="repeatBtn" class="opacity-60 hover:opacity-100"><i class="fa-solid fa-repeat"></i></button>
  </div>
  <div id="playlistContainer" class="mt-6"></div>
</div>

<div id="artistAlbumsContainer" class="max-w-md w-full mt-8 p-4 bg-gray-800 rounded-xl shadow-lg text-white">
  <h3 id="artistAlbumsTitle" class="text-xl font-semibold mb-4"></h3>
  <div id="artistAlbums"></div>
</div>

<div id="randomAlbumsContainer" class="max-w-md w-full mt-8 p-4 bg-zinc-800 rounded-xl shadow-lg text-white">
  <h3 id="randomAlbumsTitle" class="text-xl font-semibold mb-4">Álbumes Recomendado</h3>
  <div id="randomAlbums"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getDatabase, ref, get, update, child } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDiACaIKPXiSdcBo-bq4BW7z7gjpouVNos",
  authDomain: "flixplemusic.firebaseapp.com",
  databaseURL: "https://flixplemusic-default-rtdb.firebaseio.com",
  projectId: "flixplemusic",
  storageBucket: "flixplemusic.appspot.com",
  messagingSenderId: "792301053512",
  appId: "1:792301053512:web:13878703d081f1a7b3da7d"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const audio = document.getElementById('audio');
const playBtn = document.getElementById('playBtn');
const playIcon = document.getElementById('playIcon');
const progress = document.getElementById('progress');
const current = document.getElementById('current');
const total = document.getElementById('total');
const repeatBtn = document.getElementById('repeatBtn');
const shuffleBtn = document.getElementById('shuffleBtn');
const backBtn = document.getElementById('back');
const nextBtn = document.getElementById('next');
const albumCoverImg = document.getElementById('albumCover');
const trackTitleElem = document.getElementById('trackTitle');
const trackArtistElem = document.getElementById('trackArtist');
const playlistContainer = document.getElementById('playlistContainer');
const listenersCount = document.getElementById('listenersCount');

const artistAlbumsTitle = document.getElementById('artistAlbumsTitle');
const artistAlbumsDiv = document.getElementById('artistAlbums');
const randomAlbumsDiv = document.getElementById('randomAlbums');

let playlist = [];
let currentTrackIndex = 0;
let isRepeat = false;
let isShuffle = false;

function renderPlaylist() {
  playlistContainer.innerHTML = '';
  playlist.forEach((track, index) => {
    const div = document.createElement('div');
    div.classList.add('track-item');
    if (index === currentTrackIndex) div.classList.add('active');
    div.textContent = `${track.title} - ${track.artist}`;
    div.title = `${track.title} - ${track.artist}`;
    div.onclick = () => playTrack(index);
    playlistContainer.appendChild(div);
  });
}

function playTrack(index) {
  if (!playlist.length || index < 0 || index >= playlist.length) return;
  currentTrackIndex = index;
  const track = playlist[index];

  albumCoverImg.src = track.cover || 'https://via.placeholder.com/300';
  trackTitleElem.textContent = track.title || 'Título';
  trackArtistElem.textContent = track.artist || 'Artista';

  updateListenerCount(track.id);

  audio.src = track.url || '';
  audio.play().catch(() => console.log('Auto-reproducción bloqueada'));
  playIcon.classList.replace('fa-play', 'fa-pause');

  renderPlaylist();
  if (track.artist) loadArtistAlbums(track.artist);
  else { artistAlbumsTitle.textContent = ''; artistAlbumsDiv.innerHTML = ''; }
}

function formatTime(sec) {
  if (isNaN(sec)) return '0:00';
  const m = Math.floor(sec / 60);
  const s = Math.floor(sec % 60).toString().padStart(2, '0');
  return `${m}:${s}`;
}

audio.addEventListener('loadedmetadata', () => total.textContent = formatTime(audio.duration));
audio.addEventListener('timeupdate', () => {
  if (audio.duration) { progress.value = (audio.currentTime / audio.duration) * 100; current.textContent = formatTime(audio.currentTime); }
});
progress.addEventListener('input', () => { if (audio.duration) audio.currentTime = (progress.value / 100) * audio.duration; });
playBtn.addEventListener('click', () => { if (audio.paused) { audio.play(); playIcon.classList.replace('fa-play', 'fa-pause'); } else { audio.pause(); playIcon.classList.replace('fa-pause', 'fa-play'); }});
repeatBtn.addEventListener('click', () => { isRepeat = !isRepeat; audio.loop = isRepeat; repeatBtn.classList.toggle('text-green-500', isRepeat); });
shuffleBtn.addEventListener('click', () => { isShuffle = !isShuffle; shuffleBtn.classList.toggle('text-green-500', isShuffle); });
nextBtn.addEventListener('click', () => {
  if (!playlist.length) return;
  if (isShuffle) playTrack(Math.floor(Math.random() * playlist.length));
  else { if (currentTrackIndex + 1 < playlist.length) playTrack(currentTrackIndex + 1); else if (isRepeat) playTrack(0); }
});
backBtn.addEventListener('click', () => {
  if (!playlist.length) return;
  if (isShuffle) playTrack(Math.floor(Math.random() * playlist.length));
  else { if (currentTrackIndex - 1 >= 0) playTrack(currentTrackIndex - 1); else if (isRepeat) playTrack(playlist.length - 1); }
});
audio.addEventListener('ended', () => { if (isRepeat) { audio.currentTime = 0; audio.play(); } else nextBtn.click(); });

async function loadPlaylistFromFirebase(id) {
  try {
    const snapshot = await get(ref(db, `playlists/${id}`));
    if (!snapshot.exists()) { alert("Playlist no encontrada."); return; }
    const data = snapshot.val();
    if (!data.playlist || !Array.isArray(data.playlist)) { alert("Playlist inválida."); return; }
    playlist = data.playlist.map((t, i) => ({...t, id: `${id}-${i}`})); // Genera ID único
    currentTrackIndex = 0;
    renderPlaylist();
    playTrack(0);
  } catch (err) { alert("Error cargando playlist: " + err.message); console.error(err); }
}

async function loadArtistAlbums(artist) {
  artistAlbumsTitle.textContent = `Más de ${artist}`;
  artistAlbumsDiv.innerHTML = 'Cargando álbumes...';
  try {
    const albumsSnapshot = await get(ref(db, 'albums'));
    if (!albumsSnapshot.exists()) { artistAlbumsDiv.innerHTML = 'No se encontraron álbumes.'; return; }
    const albumsData = Object.values(albumsSnapshot.val()).filter(a => a.artista === artist);
    if (!albumsData.length) { artistAlbumsDiv.innerHTML = 'No hay álbumes para este artista.'; return; }
    artistAlbumsDiv.innerHTML = '';
    albumsData.forEach(album => {
      const albumDiv = document.createElement('div');
      albumDiv.classList.add('album-item');
      albumDiv.innerHTML = `<img src="${album.cover}" alt="${album.title}" /><p>${album.title}</p>`;
      albumDiv.onclick = () => { if (album.url) window.location.href = album.url; };
      artistAlbumsDiv.appendChild(albumDiv);
    });
  } catch (err) { artistAlbumsDiv.innerHTML = 'Error al cargar álbumes.'; console.error(err); }
}

async function loadRandomAlbums() {
  randomAlbumsDiv.innerHTML = 'Cargando álbumes aleatorios...';
  try {
    const albumsSnapshot = await get(ref(db, 'albums'));
    if (!albumsSnapshot.exists()) { randomAlbumsDiv.innerHTML = 'No se encontraron álbumes.'; return; }
    const albumsArray = Object.values(albumsSnapshot.val());
    for (let i = albumsArray.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [albumsArray[i], albumsArray[j]] = [albumsArray[j], albumsArray[i]]; }
    const randomSelection = albumsArray.slice(0, 6);
    randomAlbumsDiv.innerHTML = '';
    randomSelection.forEach(album => {
      const albumDiv = document.createElement('div');
      albumDiv.classList.add('album-item');
      albumDiv.innerHTML = `<img src="${album.cover}" alt="${album.title}" /><p>${album.title}</p>`;
      albumDiv.onclick = () => { if (album.url) window.location.href = album.url; };
      randomAlbumsDiv.appendChild(albumDiv);
    });
  } catch (err) { randomAlbumsDiv.innerHTML = 'Error al cargar álbumes.'; console.error(err); }
}

function getQueryParam(param) { const urlParams = new URLSearchParams(window.location.search); return urlParams.get(param); }

async function updateListenerCount(trackId) {
  const userIP = await fetch('https://api.ipify.org?format=json').then(res => res.json()).then(d => d.ip).catch(()=>`ip-${Date.now()}`);
  const listenersRef = ref(db, `playlistsListeners/${trackId}/${userIP}`);
  const now = Date.now();
  get(listenersRef).then(snapshot => {
    if (!snapshot.exists() || now - snapshot.val() > 30*60*1000) {
      update(listenersRef, now);
    }
    updateTotalListeners(trackId);
  });
}

async function updateTotalListeners(trackId) {
  const playlistRef = ref(db, `playlistsListeners/${trackId}`);
  const snapshot = await get(playlistRef);
  let count = 0;
  const now = Date.now();
  if (snapshot.exists()) {
    Object.values(snapshot.val()).forEach(ts => { if (now - ts <= 30*60*1000) count++; });
  }
  listenersCount.textContent = count;
}

window.onload = () => {
  const playlistId = getQueryParam('playlist');
  if (playlistId) loadPlaylistFromFirebase(playlistId);
  else alert("No se proporcionó playlist en la URL.");
  loadRandomAlbums();
  audio.play().catch(()=>console.log('Auto-play bloqueado'));
};

// Bloqueos de teclado y clic derecho
document.addEventListener('contextmenu', e=>e.preventDefault());
document.addEventListener('keydown', e=>{
  if(e.key==='F12'||(e.ctrlKey&&e.shiftKey&&['I','J','C'].includes(e.key.toUpperCase()))||(e.ctrlKey&&['U','S','P'].includes(e.key.toUpperCase()))) e.preventDefault();
});
window.oncontextmenu = ()=>false;

document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('a').forEach(el => { const url = el.getAttribute('href'); el.removeAttribute('href'); el.style.cursor='pointer'; el.onclick=()=>window.location.href=url; });
});
</script>
</body>
</html>
