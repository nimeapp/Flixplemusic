<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Reproductor de Playlist</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<style>
  body {
    background: linear-gradient(to bottom, #2d1600, black);
    color: white;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1rem;
    font-family: system-ui, sans-serif;
  }
  .track-item {
    cursor: pointer;
    padding: 0.5rem 0.75rem;
    border-radius: 0.375rem;
    transition: background-color 0.3s, color 0.3s;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .track-item:hover {
    background-color: #2d1600;
  }
  .track-item.active {
    color: #a3f7bf;
    font-weight: 600;
    background-color: #1a3a27;
  }
  .carousel {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    scrollbar-width: none;
    padding-bottom: 0.5rem;
  }
  .carousel::-webkit-scrollbar {
    display: none;
  }
  .album-card {
    min-width: 150px;
    background-color: #1f2937;
    padding: 0.5rem;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  .album-card:hover {
    background-color: #374151;
  }
  .album-cover {
    width: 100%;
    border-radius: 0.5rem;
    object-fit: cover;
  }
</style>
</head>
<body>

<!-- Reproductor -->
<div class="bg-gray-900 p-6 rounded-xl shadow-lg w-full max-w-md">
  <div class="flex justify-center mb-6">
    <img id="albumCover" src="https://via.placeholder.com/300" alt="Imagen del álbum" class="rounded-xl w-full max-w-xs shadow-lg" />
  </div>
  <div class="text-center mb-2">
    <h2 id="trackTitle" class="text-lg font-semibold">Título</h2>
    <p id="trackArtist" class="text-sm text-gray-400">Artista</p>
  </div>
  <audio id="audio"></audio>
  <div class="mt-4">
    <input type="range" id="progress" value="0" class="w-full accent-green-500" />
    <div class="flex justify-between text-xs text-gray-400 mt-1">
      <span id="current">0:00</span>
      <span id="total">0:00</span>
    </div>
  </div>
  <div class="flex justify-between items-center mt-4 px-6 text-2xl text-white">
    <button id="shuffleBtn" class="opacity-60 hover:opacity-100"><i class="fa-solid fa-shuffle"></i></button>
    <button id="back"><i class="fa-solid fa-backward-step"></i></button>
    <button id="playBtn" class="bg-white text-black w-14 h-14 rounded-full flex items-center justify-center shadow-lg">
      <i class="fa-solid fa-play" id="playIcon"></i>
    </button>
    <button id="next"><i class="fa-solid fa-forward-step"></i></button>
    <button id="repeatBtn" class="opacity-60 hover:opacity-100"><i class="fa-solid fa-repeat"></i></button>
  </div>
  <div id="playlistContainer" class="mt-6 max-h-48 overflow-y-auto"></div>
</div>

<!-- Más del artista -->
<div id="moreFromArtist" class="mt-8 w-full max-w-4xl hidden">
  <h3 id="artistAlbumsTitle" class="text-lg font-semibold mb-4"></h3>
  <div id="artistAlbumsContainer" class="carousel"></div>
</div>

<!-- Álbumes aleatorios -->
<div id="randomAlbumsSection" class="mt-8 w-full max-w-4xl"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getDatabase, ref, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDiACaIKPXiSdcBo-bq4BW7z7gjpouVNos",
    authDomain: "flixplemusic.firebaseapp.com",
    databaseURL: "https://flixplemusic-default-rtdb.firebaseio.com",
    projectId: "flixplemusic",
    storageBucket: "flixplemusic.appspot.com",
    messagingSenderId: "792301053512",
    appId: "1:792301053512:web:13878703d081f1a7b3da7d"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const audio = document.getElementById('audio');
  const playBtn = document.getElementById('playBtn');
  const playIcon = document.getElementById('playIcon');
  const progress = document.getElementById('progress');
  const current = document.getElementById('current');
  const total = document.getElementById('total');
  const repeatBtn = document.getElementById('repeatBtn');
  const shuffleBtn = document.getElementById('shuffleBtn');
  const backBtn = document.getElementById('back');
  const nextBtn = document.getElementById('next');
  const albumCoverImg = document.getElementById('albumCover');
  const trackTitleElem = document.getElementById('trackTitle');
  const trackArtistElem = document.getElementById('trackArtist');
  const playlistContainer = document.getElementById('playlistContainer');
  const moreFromArtist = document.getElementById('moreFromArtist');
  const artistAlbumsTitle = document.getElementById('artistAlbumsTitle');
  const artistAlbumsContainer = document.getElementById('artistAlbumsContainer');
  const randomAlbumsSection = document.getElementById('randomAlbumsSection');

  let playlist = [];
  let currentTrackIndex = 0;
  let isRepeat = false;
  let isShuffle = false;

  function renderPlaylist() {
    playlistContainer.innerHTML = '';
    playlist.forEach((track, index) => {
      const div = document.createElement('div');
      div.classList.add('track-item');
      if (index === currentTrackIndex) div.classList.add('active');
      div.textContent = `${track.title} - ${track.artist}`;
      div.onclick = () => playTrack(index);
      playlistContainer.appendChild(div);
    });
  }

  function playTrack(index) {
    if (!playlist.length) return;
    currentTrackIndex = index;
    const track = playlist[index];
    albumCoverImg.src = track.cover || 'https://via.placeholder.com/300';
    trackTitleElem.textContent = track.title;
    trackArtistElem.textContent = track.artist;
    audio.src = track.url;
    audio.play().catch(e => console.warn("Autoplay bloqueado:", e));
    playIcon.classList.replace('fa-play', 'fa-pause');
    renderPlaylist();
    loadAlbumsByArtist(track.artist);
  }

  async function loadAlbumsByArtist(artistName) {
    try {
      // Aquí cambiamos 'artist' por 'artista' para que coincida con tu base de datos
      const albumsRef = query(ref(db, 'albums'), orderByChild('artista'), equalTo(artistName));
      const snapshot = await get(albumsRef);
      artistAlbumsContainer.innerHTML = '';
      if (snapshot.exists()) {
        artistAlbumsTitle.textContent = `Más de ${artistName}`;
        snapshot.forEach(albumSnap => {
          const album = albumSnap.val();

          // Extraemos playlistId desde la URL si está presente
          let playlistId = null;
          if (album.url) {
            try {
              const urlObj = new URL(album.url);
              playlistId = urlObj.searchParams.get('playlist');
            } catch {
              playlistId = null;
            }
          }

          const albumDiv = document.createElement('div');
          albumDiv.className = 'album-card';
          albumDiv.innerHTML = `
            <img src="${album.cover}" alt="${album.title}" class="album-cover mb-2" />
            <p class="text-sm font-semibold">${album.title}</p>
          `;
          albumDiv.onclick = () => {
            if (playlistId) loadPlaylistFromFirebase(playlistId, true);
            else alert('No hay playlist disponible para este álbum');
          };
          artistAlbumsContainer.appendChild(albumDiv);
        });
        moreFromArtist.classList.remove('hidden');
      } else {
        moreFromArtist.classList.add('hidden');
      }
      await loadRandomAlbums();
    } catch (error) {
      console.error("Error cargando álbumes del artista:", error);
    }
  }

  async function loadRandomAlbums() {
    try {
      const albumsRef = ref(db, 'albums');
      const snapshot = await get(albumsRef);
      if (!snapshot.exists()) return;

      const albumsArray = Object.values(snapshot.val());
      randomAlbumsSection.innerHTML = '';

      for (let i = 0; i < 2; i++) {
        // Filtramos solo álbumes con url para evitar errores
        const filteredAlbums = albumsArray.filter(a => !!a.url);

        const shuffled = [...filteredAlbums].sort(() => 0.5 - Math.random()).slice(0, 6);

        const section = document.createElement('div');
        section.className = 'mb-6';
        section.innerHTML = `<h3 class="text-lg font-semibold mb-4">Recomendados</h3>`;

        const carousel = document.createElement('div');
        carousel.className = 'carousel';

        shuffled.forEach(album => {
          let playlistId = null;
          if (album.url) {
            try {
              const urlObj = new URL(album.url);
              playlistId = urlObj.searchParams.get('playlist');
            } catch {
              playlistId = null;
            }
          }

          const div = document.createElement('div');
          div.className = 'album-card';
          div.innerHTML = `
            <img src="${album.cover}" alt="${album.title}" class="album-cover mb-2" />
            <p class="text-sm font-semibold">${album.title}</p>
          `;
          div.onclick = () => {
            if (playlistId) loadPlaylistFromFirebase(playlistId, true);
            else alert('No hay playlist disponible para este álbum');
          };
          carousel.appendChild(div);
        });

        section.appendChild(carousel);
        randomAlbumsSection.appendChild(section);
      }
    } catch (error) {
      console.error("Error cargando álbumes aleatorios:", error);
    }
  }

  async function loadPlaylistFromFirebase(id, autoPlay = false) {
    try {
      const snapshot = await get(ref(db, `playlists/${id}`));
      if (!snapshot.exists()) {
        alert("Playlist no encontrada.");
        return;
      }
      playlist = snapshot.val().playlist || [];
      currentTrackIndex = 0;
      renderPlaylist();
      if (autoPlay) playTrack(0);
    } catch (error) {
      alert("Error cargando playlist: " + error.message);
      console.error(error);
    }
  }

  function formatTime(sec) {
    if (isNaN(sec)) return '0:00';
    const m = Math.floor(sec / 60);
    const s = Math.floor(sec % 60).toString().padStart(2, '0');
    return `${m}:${s}`;
  }

  audio.addEventListener('loadedmetadata', () => {
    total.textContent = formatTime(audio.duration);
  });

  audio.addEventListener('timeupdate', () => {
    if (audio.duration) {
      progress.value = (audio.currentTime / audio.duration) * 100;
      current.textContent = formatTime(audio.currentTime);
    }
  });

  progress.addEventListener('input', () => {
    if (audio.duration) {
      audio.currentTime = (progress.value / 100) * audio.duration;
    }
  });

  playBtn.addEventListener('click', () => {
    if (audio.paused) {
      audio.play();
      playIcon.classList.replace('fa-play', 'fa-pause');
    } else {
      audio.pause();
      playIcon.classList.replace('fa-pause', 'fa-play');
    }
  });

  repeatBtn.addEventListener('click', () => {
    isRepeat = !isRepeat;
    audio.loop = isRepeat;
    repeatBtn.classList.toggle('text-green-500', isRepeat);
  });

  shuffleBtn.addEventListener('click', () => {
    isShuffle = !isShuffle;
    shuffleBtn.classList.toggle('text-green-500', isShuffle);
  });

  nextBtn.addEventListener('click', () => {
    if (!playlist.length) return;
    if (isShuffle) {
      const randomIndex = Math.floor(Math.random() * playlist.length);
      playTrack(randomIndex);
    } else {
      if (currentTrackIndex + 1 < playlist.length) {
        playTrack(currentTrackIndex + 1);
      } else if (isRepeat) {
        playTrack(0);
      }
    }
  });

  backBtn.addEventListener('click', () => {
    if (!playlist.length) return;
    if (isShuffle) {
      const randomIndex = Math.floor(Math.random() * playlist.length);
      playTrack(randomIndex);
    } else {
      if (currentTrackIndex - 1 >= 0) {
        playTrack(currentTrackIndex - 1);
      } else if (isRepeat) {
        playTrack(playlist.length - 1);
      }
    }
  });

  audio.addEventListener('ended', () => {
    if (isRepeat) {
      audio.currentTime = 0;
      audio.play();
    } else {
      nextBtn.click();
    }
  });

  function getQueryParam(param) {
    return new URLSearchParams(window.location.search).get(param);
  }

  window.onload = () => {
    const playlistId = getQueryParam('playlist');
    if (playlistId) {
      loadPlaylistFromFirebase(playlistId, true);
    } else {
      alert("No se proporcionó playlist en la URL.");
    }
  };
</script>
</body>
</html>
