<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Menú Inferior con Contenido Dinámico</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body {
    margin: 0;
    background-color: #000;
    color: white;
    font-family: sans-serif;
    overflow-x: hidden;
  }

  /* Contenedor contenido dinámico */
  #content {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 56px; /* altura menú */
    background-color: #111;
    overflow-y: auto;
    padding: 1rem;
    color: black;
  }

  /* Animación slider sólo cuando se agrega esta clase */
  @keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  .slide-in {
    animation: slideInRight 0.4s ease forwards;
  }

  nav {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background-color: #000;
    border-top: 2px solid #90ee90; /* verde claro */
    display: flex;
    justify-content: space-around;
    padding: 0.5rem 0;
    font-size: 10px;
    z-index: 9999;
  }

  nav button {
    background: none;
    border: none;
    color: inherit;
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
  }

  nav button:hover {
    opacity: 0.8;
  }

  #avatar {
    width: 32px; height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
    user-select: none;
    color: white;
    border: 2px solid #90ee90; /* borde verde claro */
    overflow: hidden;
  }

  .active-tab i,
  .active-tab span {
    color: #a855f7 !important;
    stroke: #a855f7 !important;
  }

  /* Estilos para contenido perfil (que viene de perfiluser.html) */
  #contenedor-perfil {
    background: white;
    padding: 1rem;
    border-radius: 0.5rem;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-top: 1rem;
  }

  #contenedor-perfil #avatar {
    width: 64px; height: 64px;
    background: #888;
    color: white;
    font-size: 2rem;
    font-weight: bold;
    display: flex;
    justify-content: center;
    align-items: center;
    border-radius: 50%;
    overflow: hidden;
  }

  #seccion-mi-informacion {
    background: white;
    padding: 1rem;
    margin-top: 1rem;
    border-radius: 0.5rem;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    max-width: 400px;
    color: black;
    position: relative;
    display: none;
  }

  #seccion-mi-informacion.visible {
    display: block;
  }

  #btn-cerrar-mi-informacion {
    background: none;
    border: none;
    cursor: pointer;
  }

  #opciones-container {
    background: white;
    margin-top: 1rem;
    padding: 1rem;
    border-radius: 0.5rem;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    max-width: 500px;
    color: black;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  #opciones-container button,
  #opciones-container a {
    background: #f0f0f0;
    padding: 0.75rem;
    border-radius: 0.5rem;
    text-decoration: none;
    color: #2563eb;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
  }

  #opciones-container button:hover,
  #opciones-container a:hover {
    background: #dbeafe;
  }
</style>
</head>
<body>

<!-- Contenedor para cargar contenido dinámico -->
<div id="content"></div>

<!-- Menú Inferior -->
<nav>
  <button aria-label="Inicio" onclick="loadPage('https://nimeapp.github.io/Flixplemusic/index.html', this, false)">
    <i data-lucide="home" class="text-purple-500"></i>
    <span>Inicio</span>
  </button>

  <button aria-label="Buscar" onclick="loadPage('https://nimeapp.github.io/Flixplemusic/buscador.html', this, false)">
    <i data-lucide="search" class="text-purple-500"></i>
    <span>Buscar</span>
  </button>

  <button aria-label="Tu Lista" onclick="loadPage('https://nimeapp.github.io/Flixplemusic/tulista.html', this, false)">
    <i data-lucide="list" class="text-purple-500"></i>
    <span>Tu Lista</span>
  </button>

  <button id="profile-btn" aria-label="Perfil" style="padding:0;" onclick="loadPage('https://nimeapp.github.io/Flixplemusic/perfiluser.html', this, true)">
    <div id="avatar"></div>
  </button>
</nav>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDiACaIKPXiSdcBo-bq4BW7z7gjpouVNos",
    authDomain: "flixplemusic.firebaseapp.com",
    databaseURL: "https://flixplemusic-default-rtdb.firebaseio.com",
    projectId: "flixplemusic",
    storageBucket: "flixplemusic.firebasestorage.app",
    messagingSenderId: "792301053512",
    appId: "1:792301053512:web:13878703d081f1a7b3da7d"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  const avatarDiv = document.getElementById('avatar');
  const contentDiv = document.getElementById('content');

  // Función para establecer avatar
  function setAvatar(initials, color, photoURL) {
    if(photoURL){
      avatarDiv.innerHTML = `<img src="${photoURL}" alt="avatar" class="w-full h-full object-cover rounded-full">`;
      avatarDiv.style.backgroundColor = '';
      avatarDiv.textContent = '';
    } else {
      avatarDiv.textContent = initials;
      avatarDiv.style.backgroundColor = color;
    }
  }

  // Carga usuario y avatar en menú
  onAuthStateChanged(auth, async (user) => {
    if(user){
      const userRef = ref(db, 'users/' + user.uid);
      const snapshot = await get(userRef);
      if(snapshot.exists()){
        const data = snapshot.val();
        setAvatar(data.initials || '', data.profileColor || '#555', data.photoURL || user.photoURL);
      } else {
        const initial = user.email ? user.email.charAt(0).toUpperCase() : '';
        setAvatar(initial, '#555');
      }
    } else {
      // Si no hay usuario, redirige al login fuera del iframe
      window.top.location.href = 'https://nimeapp.github.io/Flixplemusic/loginuser.html';
    }
  });

  // Función para cargar una página dentro del div #content
  // con opción para animar slider sólo para perfil
  window.loadPage = async function(url, button, withSlide) {
    // Marca botón activo
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active-tab'));
    if(button) button.classList.add('active-tab');

    try {
      const res = await fetch(url);
      if(!res.ok) throw new Error('No se pudo cargar la página');

      const text = await res.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(text, 'text/html');
      // Obtiene solo el contenido del body
      const bodyContent = doc.body.innerHTML;

      // Inyecta contenido
      contentDiv.innerHTML = bodyContent;

      // Si es perfil, añade animación slide-in
      if(withSlide){
        contentDiv.classList.remove('slide-in');
        // Trigger reflow para reiniciar animación
        void contentDiv.offsetWidth;
        contentDiv.classList.add('slide-in');
      } else {
        contentDiv.classList.remove('slide-in');
      }

      // Reactiva iconos lucide en contenido nuevo
      lucide.createIcons();

      // Inicializa lógica de perfil si cargaste perfiluser.html
      if(withSlide){
        initPerfilUser();
      }

    } catch(err){
      console.error(err);
      alert('Error al cargar la página.');
    }
  };

  // Inicializar contenido perfil (igual que en perfiluser.html)
  function initPerfilUser(){
    const avatarProfile = contentDiv.querySelector('#avatar');
    const userNameSpan = contentDiv.querySelector('#user-name');
    const btnMiInfo = contentDiv.querySelector('#btn-mi-informacion');
    const seccionMiInfo = contentDiv.querySelector('#seccion-mi-informacion');
    const btnCerrarMiInfo = contentDiv.querySelector('#btn-cerrar-mi-informacion');
    const infoNombre = contentDiv.querySelector('#info-nombre');
    const infoCorreo = contentDiv.querySelector('#info-correo');
    const btnCambiarContrasena = contentDiv.querySelector('#btn-cambiar-contrasena');

    let usuarioActual = null;

    // Carga usuario Firebase para perfil
    onAuthStateChanged(auth, async (user) => {
      if(user){
        try {
          const userRef = ref(db, 'users/' + user.uid);
          const snapshot = await get(userRef);
          if(snapshot.exists()){
            const data = snapshot.val();
            usuarioActual = { ...data, email: data.email || user.email, displayName: data.name || user.displayName };
            userNameSpan.textContent = data.name || user.displayName || '';
            if(data.photoURL || user.photoURL){
              avatarProfile.innerHTML = `<img src="${data.photoURL || user.photoURL}" alt="avatar" class="w-full h-full object-cover rounded-full">`;
              avatarProfile.style.backgroundColor = '';
              avatarProfile.textContent = '';
            } else {
              const initials = data.initials || (data.name ? data.name.charAt(0).toUpperCase() : '');
              avatarProfile.textContent = initials;
              avatarProfile.style.backgroundColor = data.profileColor || '#555';
            }
          } else {
            usuarioActual = { displayName: user.displayName, email: user.email, photoURL: user.photoURL };
            userNameSpan.textContent = user.displayName || '';
            if(user.photoURL){
              avatarProfile.innerHTML = `<img src="${user.photoURL}" alt="avatar" class="w-full h-full object-cover rounded-full">`;
              avatarProfile.style.backgroundColor = '';
              avatarProfile.textContent = '';
            } else {
              avatarProfile.textContent = '';
              avatarProfile.style.backgroundColor = '#555';
            }
          }
        } catch(e){
          console.error('Error leyendo usuario en perfil:', e);
          usuarioActual = { displayName: user.displayName, email: user.email, photoURL: user.photoURL };
          userNameSpan.textContent = user.displayName || '';
          avatarProfile.textContent = '';
          avatarProfile.style.backgroundColor = '#555';
        }
        cerrarMiInformacion();
      } else {
        usuarioActual = null;
        userNameSpan.textContent = 'No has iniciado sesión';
        avatarProfile.textContent = '';
        avatarProfile.style.backgroundColor = '#555';
        cerrarMiInformacion();
      }
    });

    // Funciones abrir/cerrar sección info
    function abrirMiInformacion(){
      if(!usuarioActual) return;
      seccionMiInfo.classList.add('visible');
      infoNombre.textContent = usuarioActual.name || usuarioActual.displayName || 'Sin nombre';
      infoCorreo.textContent = usuarioActual.email || 'Sin correo';
    }
    function cerrarMiInformacion(){
      seccionMiInfo.classList.remove('visible');
    }

    btnMiInfo?.addEventListener('click', abrirMiInformacion);
    btnCerrarMiInfo?.addEventListener('click', cerrarMiInformacion);

    btnCambiarContrasena?.addEventListener('click', e => {
      e.stopPropagation();
      window.top.location.href = 'https://nimeapp.github.io/Flixplemusic/reset_password.html';
    });
  }

  // Opcional: cargar página inicio automáticamente si quieres (o deja vacío)
  // loadPage('https://nimeapp.github.io/Flixplemusic/index.html', null, false);
</script>

<!-- Lucide Icons -->
<script src="https://unpkg.com/lucide@latest"></script>
<script>
  lucide.createIcons();
</script>

</body>
</html>
