<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Perfil de Usuario</title>

<!-- Fuentes e iconos -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<style>
  /* ===== BODY ===== */
  body {
    font-family: 'Montserrat', sans-serif;
    margin: 0;
    padding-bottom: 60px;
    background: #121212;
    color: #eee;
  }

  /* ===== NAVEGACIÓN INFERIOR ===== */
  nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #000;
    border-top: 2px solid #90ee90;
    display: flex;
    justify-content: space-around;
    padding: 0.5rem 0;
    font-size: 10px;
    z-index: 10001;
  }

  nav a,
  nav button {
    background: none;
    border: none;
    color: inherit;
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    text-decoration: none;
    font-size: 10px;
  }

  nav a:hover,
  nav button:hover {
    opacity: 0.8;
  }

  nav a.active-tab i,
  nav a.active-tab span {
    color: #a855f7 !important;
    stroke: #a855f7 !important;
  }

  #avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
    color: white;
    border: 2px solid #90ee90;
    overflow: hidden;
    background-color: #555;
  }

  /* ===== SLIDER PERFIL ===== */
  #profile-container {
    position: fixed;
    top: 0;
    right: 0;
    width: 100%;
    max-width: 360px;
    height: calc(100vh - 48px);
    background: #f5f6f7;
    color: black;
    font-family: sans-serif;
    padding: 1rem;
    box-sizing: border-box;
    overflow-y: auto;
    z-index: 10000;
    transform: translateX(100%);
    transition: transform 0.4s ease;
    border-left: 1px solid #ddd;
    bottom: 48px;
  }

  #profile-container.visible {
    transform: translateX(0);
  }

  #profile-content {
    animation: slideInRight 0.4s ease-out forwards;
  }

  @keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  #contenedor-perfil {
    background: white;
    padding: 1rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    border-radius: 0.5rem;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
  }

  #avatar-profile {
    width: 64px;
    height: 64px;
    background: #888;
    color: white;
    font-size: 2rem;
    font-weight: bold;
    display: flex;
    justify-content: center;
    align-items: center;
    border-radius: 50%;
    overflow: hidden;
  }

  #user-name {
    font-weight: 600;
    font-size: 1.2rem;
    color: #333;
  }

  /* ===== SECCIÓN MI INFORMACIÓN ===== */
  #seccion-mi-informacion {
    background: white;
    padding: 1rem;
    margin-top: 1rem;
    border-radius: 0.5rem;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    max-width: 400px;
    display: none;
    color: black;
  }

  #seccion-mi-informacion.visible {
    display: block;
  }

  #btn-cerrar-mi-informacion {
    background: none;
    border: none;
    cursor: pointer;
  }

  /* ===== OPCIONES DEL SLIDER ===== */
  #opciones-container {
    background: white;
    margin-top: 1rem;
    padding: 1rem;
    border-radius: 0.5rem;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    max-width: 500px;
    color: black;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  #opciones-container button,
  #opciones-container a {
    background: #f0f0f0;
    padding: 0.75rem;
    border-radius: 0.5rem;
    text-decoration: none;
    color: #2563eb;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
  }

  #opciones-container button:hover,
  #opciones-container a:hover {
    background: #dbeafe;
  }

  /* ===== BOTÓN LOGOUT ANCHO COMPLETO ===== */
  .btn-logout {
    background-color: rgba(139,92,246,0.3);
    border: 2px solid rgba(132,204,22,0.3);
    color: #8b5cf6;
    font-weight: 600;
    cursor: pointer;
    justify-content: center;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem;
    border-radius: 0.5rem;
    width: 100%; /* Abarca todo el contenedor */
    grid-column: 1 / -1; /* Ocupa ambas columnas */
  }

  .btn-logout:hover {
    background-color: rgba(139,92,246,0.5);
    border-color: rgba(132,204,22,0.6);
  }
</style>
</head>
<body>

<!-- Menú Inferior -->
<nav>
  <a href="https://nimeapp.github.io/Flixplemusic/index.html" target="_top" aria-label="Inicio">
    <i data-lucide="home" class="text-purple-500"></i><span>Inicio</span>
  </a>
  <a href="https://nimeapp.github.io/Flixplemusic/buscador.html" target="_top" aria-label="Buscar">
    <i data-lucide="search" class="text-purple-500"></i><span>Buscar</span>
  </a>
  <a href="https://nimeapp.github.io/Flixplemusic/tulista.html" target="_top" aria-label="Tu Lista">
    <i data-lucide="list" class="text-purple-500"></i><span>Tu Lista</span>
  </a>
  <button id="profile-btn" aria-label="Perfil" style="padding:0;">
    <div id="avatar"></div>
  </button>
</nav>

<!-- Slider de Perfil -->
<div id="profile-container" aria-label="Perfil de Usuario" role="dialog" aria-modal="true" aria-hidden="true" tabindex="-1">
  <div id="profile-content">
    <div id="contenedor-perfil">
      <div id="avatar-profile"></div>
      <div><span id="user-name"></span></div>
    </div>

    <div id="seccion-mi-informacion">
      <h2 class="text-xl font-semibold mb-4 flex justify-between items-center">
        Mi Información
        <button id="btn-cerrar-mi-informacion" title="Cerrar información">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </h2>
      <p><strong>Nombre:</strong> <span id="info-nombre"></span></p>
      <p><strong>Correo:</strong> <span id="info-correo"></span></p>
      <button id="btn-cambiar-contrasena" class="mt-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md">Cambiar contraseña</button>
    </div>

    <div id="opciones-container">
      <button id="btn-mi-informacion"><i data-lucide="user"></i>Mi información</button>
      <button id="btn-feeds"><i data-lucide="newspaper"></i>Feeds</button>
      <a href="go:politicas-privacidad"><i data-lucide="shield-check"></i>Políticas y Privacidad</a>
      <a href="go:politica-uso"><i data-lucide="file-text"></i>Política de Uso</a>
      <a href="go:cookies"><i data-lucide="cookie"></i>Cookies</a>
      <a href="go:ayuda"><i data-lucide="help-circle"></i>Ayuda</a>
      <a href="go:contacto"><i data-lucide="mail"></i>Contacto</a>
      <a href="go:acerca"><i data-lucide="info"></i>Acerca de</a>
      <a href="go:compartir"><i data-lucide="share-2"></i>Compartir la app</a>
      <a href="go:sugerencias"><i data-lucide="message-circle"></i>Enviar sugerencias</a>
      <button id="btn-logout" class="btn-logout" type="button" title="Cerrar sesión">
        <i data-lucide="log-out"></i><span>Cerrar sesión</span>
      </button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDiACaIKPXiSdcBo-bq4BW7z7gjpouVNos",
  authDomain: "flixplemusic.firebaseapp.com",
  databaseURL: "https://flixplemusic-default-rtdb.firebaseio.com",
  projectId: "flixplemusic",
  storageBucket: "flixplemusic.appspot.com",
  messagingSenderId: "792301053512",
  appId: "1:792301053512:web:13878703d081f1a7b3da7d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const avatarDiv = document.getElementById('avatar');
const avatarProfile = document.getElementById('avatar-profile');
const userNameSpan = document.getElementById('user-name');
const profileContainer = document.getElementById('profile-container');
const btnMiInfo = document.getElementById('btn-mi-informacion');
const seccionMiInfo = document.getElementById('seccion-mi-informacion');
const btnCerrarMiInfo = document.getElementById('btn-cerrar-mi-informacion');
const infoNombre = document.getElementById('info-nombre');
const infoCorreo = document.getElementById('info-correo');
const btnCambiarContrasena = document.getElementById('btn-cambiar-contrasena');
const btnLogout = document.getElementById('btn-logout');

let usuarioActual = null;

btnLogout.addEventListener('click', async () => {
  try {
    await signOut(auth);
    window.top.location.href = 'https://nimeapp.github.io/Flixplemusic/loginuser.html';
  } catch (error) {
    console.error(error);
    alert('No se pudo cerrar sesión');
  }
});

function setAvatar(initials, color, photoURL) {
  if(photoURL){
    avatarDiv.innerHTML = `<img src="${photoURL}" class="w-full h-full object-cover rounded-full">`;
    avatarProfile.innerHTML = avatarDiv.innerHTML;
  } else {
    avatarDiv.textContent = initials || '';
    avatarDiv.style.backgroundColor = color || '#555';
    avatarProfile.textContent = initials || '';
    avatarProfile.style.backgroundColor = color || '#555';
  }
}

onAuthStateChanged(auth, async (user) => {
  if(user){
    const userRef = ref(db, 'users/' + user.uid);
    const snapshot = await get(userRef);
    if(snapshot.exists()){
      const data = snapshot.val();
      usuarioActual = { ...data, email: data.email||user.email, displayName: data.name||user.displayName };
      userNameSpan.textContent = data.name||user.displayName||'';
      setAvatar(data.initials || (data.name ? data.name.charAt(0).toUpperCase() : ''), data.profileColor||'#555', data.photoURL||user.photoURL);
    }
  } else {
    window.top.location.href = 'https://nimeapp.github.io/Flixplemusic/loginuser.html';
  }
  cerrarMiInformacion();
});

document.getElementById('profile-btn').addEventListener('click', ()=>{
  profileContainer.classList.toggle('visible');
  profileContainer.setAttribute('aria-hidden', profileContainer.classList.contains('visible') ? 'false' : 'true');
  if(!profileContainer.classList.contains('visible')) cerrarMiInformacion();
});

function abrirMiInformacion(){
  if(!usuarioActual) return;
  seccionMiInfo.classList.add('visible');
  infoNombre.textContent = usuarioActual.name || usuarioActual.displayName || 'Sin nombre';
  infoCorreo.textContent = usuarioActual.email || 'Sin correo';
}
function cerrarMiInformacion(){ seccionMiInfo.classList.remove('visible'); }

btnMiInfo.addEventListener('click', abrirMiInformacion);
btnCerrarMiInfo.addEventListener('click', cerrarMiInformacion);
btnCambiarContrasena.addEventListener('click',()=> window.top.location.href='https://nimeapp.github.io/Flixplemusic/reset_password.html');

document.addEventListener('DOMContentLoaded', ()=>lucide.createIcons());
</script>

</body>
</html>
