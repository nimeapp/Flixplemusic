<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mis Favoritos - FlixpleMusic</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-color: black;
      color: white;
      font-family: system-ui, sans-serif;
      padding: 1rem;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      font-size: 1.75rem;
      margin-bottom: 1rem;
      font-weight: 700;
      text-align: center;
    }
    ul {
      list-style: none;
      padding: 0;
      width: 100%;
      max-width: 480px;
    }
    li {
      display: flex;
      align-items: center;
      background: #1a1a1a;
      margin-bottom: 0.75rem;
      border-radius: 0.5rem;
      padding: 0.6rem 1rem;
      transition: background-color 0.3s;
      cursor: pointer;
      user-select: none;
    }
    li:hover {
      background: #2d2d2d;
    }
    img.cover {
      width: 64px;
      height: 64px;
      border-radius: 0.5rem;
      object-fit: cover;
      margin-right: 1rem;
      flex-shrink: 0;
      pointer-events: none;
      user-select: none;
    }
    div.info {
      flex-grow: 1;
      overflow: hidden;
      user-select: none;
    }
    span.track-title {
      font-weight: 600;
      font-size: 1.1rem;
      color: #a3f7bf;
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      user-select: none;
      pointer-events: none;
    }
    div.artist-name {
      font-size: 0.9rem;
      color: #bbb;
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      user-select: none;
      pointer-events: none;
    }

    /* Reproductor flotante */
    #floatingPlayer {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      background: #1a1a1a;
      border-top-left-radius: 1rem;
      border-top-right-radius: 1rem;
      width: 100%;
      max-width: 480px;
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.7);
      z-index: 999;
    }
    #floatingPlayer div.controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    #floatingPlayer button {
      background: none;
      border: none;
      color: white;
      font-size: 1.3rem;
      cursor: pointer;
    }
    #floatingPlayer span {
      color: #a3f7bf;
      font-weight: 600;
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: block;
    }
  </style>
</head>
<body>
  <h1>Canciones Favoritas</h1>
  <ul id="favoritesList">
    <li>Cargando...</li>
  </ul>

  <!-- Reproductor flotante -->
  <div id="floatingPlayer">
    <span id="fpTrackTitle">Título</span>
    <div class="controls">
      <button id="fpPrev"><i class="fa-solid fa-backward-step"></i></button>
      <button id="fpPlayPause"><i class="fa-solid fa-play"></i></button>
      <button id="fpNext"><i class="fa-solid fa-forward-step"></i></button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    // Importa la API del reproductor
    class MusicPlayer {
      constructor() {
        this.audio = new Audio();
        this.playlist = [];
        this.currentTrackIndex = 0;
        this.isPlaying = false;
        this.audio.addEventListener('ended', () => this.nextTrack());
        this.audio.addEventListener('timeupdate', () => {
          if (this.onTimeUpdate) this.onTimeUpdate(this.audio.currentTime);
        });
      }
      play(trackUrl) {
        if (trackUrl) this.audio.src = trackUrl;
        this.audio.play();
        this.isPlaying = true;
        if (this.onPlay) this.onPlay(this.getCurrentTrack());
      }
      pause() {
        this.audio.pause();
        this.isPlaying = false;
      }
      toggle() {
        this.isPlaying ? this.pause() : this.play();
        this.isPlaying = !this.isPlaying;
      }
      setPlaylist(playlistArray, startIndex = 0) {
        this.playlist = playlistArray;
        this.currentTrackIndex = startIndex;
      }
      getCurrentTrack() {
        return this.playlist[this.currentTrackIndex] || {};
      }
      nextTrack() {
        if (!this.playlist.length) return;
        this.currentTrackIndex = (this.currentTrackIndex + 1) % this.playlist.length;
        this.play(this.playlist[this.currentTrackIndex].url);
      }
      prevTrack() {
        if (!this.playlist.length) return;
        this.currentTrackIndex = (this.currentTrackIndex - 1 + this.playlist.length) % this.playlist.length;
        this.play(this.playlist[this.currentTrackIndex].url);
      }
    }
    const player = new MusicPlayer();

    const firebaseConfig = {
      apiKey: "AIzaSyDiACaIKPXiSdcBo-bq4BW7z7gjpouVNos",
      authDomain: "flixplemusic.firebaseapp.com",
      databaseURL: "https://flixplemusic-default-rtdb.firebaseio.com",
      projectId: "flixplemusic",
      storageBucket: "flixplemusic.appspot.com",
      messagingSenderId: "792301053512",
      appId: "1:792301053512:web:13878703d081f1a7b3da7d"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const FAVORITES_KEY = 'flixplemusic_favorites';
    const favoritesList = document.getElementById('favoritesList');

    const fpTrackTitle = document.getElementById('fpTrackTitle');
    const fpPlayPause = document.getElementById('fpPlayPause');
    const fpPrev = document.getElementById('fpPrev');
    const fpNext = document.getElementById('fpNext');

    async function loadFavoriteTracks() {
      const favs = JSON.parse(localStorage.getItem(FAVORITES_KEY) || '[]');
      if (favs.length === 0) {
        favoritesList.innerHTML = '<li>No tienes canciones favoritas aún.</li>';
        return;
      }
      favoritesList.innerHTML = '<li>Cargando...</li>';

      const promises = favs.map(async (trackId) => {
        try {
          const snapshot = await get(ref(db, `tracks/${trackId}`));
          if (!snapshot.exists()) return null;
          return { id: trackId, ...snapshot.val() };
        } catch {
          return null;
        }
      });

      const tracks = (await Promise.all(promises)).filter(Boolean);
      if (tracks.length === 0) {
        favoritesList.innerHTML = '<li>No se encontraron canciones favoritas válidas.</li>';
        return;
      }

      // Configura la playlist en el player
      player.setPlaylist(tracks);

      favoritesList.innerHTML = '';
      tracks.forEach((track, index) => {
        const li = document.createElement('li');

        const img = document.createElement('img');
        img.src = track.cover || 'https://via.placeholder.com/64?text=No+Cover';
        img.alt = `Portada de ${track.artist}`;
        img.className = 'cover';

        const infoDiv = document.createElement('div');
        infoDiv.className = 'info';

        const titleSpan = document.createElement('span');
        titleSpan.textContent = track.title || 'Título';
        titleSpan.className = 'track-title';

        const artistDiv = document.createElement('div');
        artistDiv.textContent = track.artist || 'Artista';
        artistDiv.className = 'artist-name';

        infoDiv.appendChild(titleSpan);
        infoDiv.appendChild(artistDiv);

        li.appendChild(img);
        li.appendChild(infoDiv);

        li.addEventListener('click', () => {
          player.currentTrackIndex = index;
          player.play(track.url);
          fpTrackTitle.textContent = `${track.title} - ${track.artist}`;
          fpPlayPause.innerHTML = '<i class="fa-solid fa-pause"></i>';
        });

        favoritesList.appendChild(li);
      });
    }

    // Controles del reproductor flotante
    fpPlayPause.addEventListener('click', () => {
      player.toggle();
      fpPlayPause.innerHTML = player.isPlaying ? '<i class="fa-solid fa-pause"></i>' : '<i class="fa-solid fa-play"></i>';
      const track = player.getCurrentTrack();
      fpTrackTitle.textContent = `${track.title || 'Título'} - ${track.artist || 'Artista'}`;
    });

    fpPrev.addEventListener('click', () => {
      player.prevTrack();
      const track = player.getCurrentTrack();
      fpTrackTitle.textContent = `${track.title || 'Título'} - ${track.artist || 'Artista'}`;
      fpPlayPause.innerHTML = '<i class="fa-solid fa-pause"></i>';
    });

    fpNext.addEventListener('click', () => {
      player.nextTrack();
      const track = player.getCurrentTrack();
      fpTrackTitle.textContent = `${track.title || 'Título'} - ${track.artist || 'Artista'}`;
      fpPlayPause.innerHTML = '<i class="fa-solid fa-pause"></i>';
    });

    window.onload = loadFavoriteTracks;
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
</body>
</html>
