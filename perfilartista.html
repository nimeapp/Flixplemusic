<!DOCTYPE html>
<html lang="es" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Perfil Artista</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .carousel {
      display: flex;
      overflow-x: auto;
      scroll-behavior: smooth;
      gap: 1rem;
      padding-bottom: 1rem;
    }
    .carousel::-webkit-scrollbar {
      display: none;
    }
  </style>
</head>
<body class="bg-black text-white min-h-screen">

  <header class="flex items-center gap-4 p-6 bg-gray-900 shadow-lg">
    <img id="fotoArtista" alt="Foto Artista" class="w-24 h-24 rounded-full border-4 border-green-400 object-cover" />
    <div class="flex items-center gap-2 text-4xl font-bold">
      <span id="nombreArtista"></span>
      <img id="iconoVerificado" src="https://cdn-icons-png.flaticon.com/512/11820/11820312.png" alt="Verificado" class="w-6 h-6 hidden" />
    </div>
  </header>

  <main class="p-6 max-w-6xl mx-auto">

    <section class="mb-8">
      <h2 class="text-2xl font-semibold mb-4">Álbumes</h2>
      <div id="contenedorAlbums" class="carousel"></div>
    </section>

    <section class="mb-8">
      <h2 class="text-2xl font-semibold mb-4">Canciones</h2>
      <div id="contenedorCanciones" class="space-y-3 max-h-96 overflow-y-auto bg-gray-800 p-4 rounded"></div>
    </section>

    <section class="mb-8 text-center">
      <h2 class="text-2xl font-semibold mb-4">Estadísticas</h2>
      <div class="text-lg space-y-1">
        <p><strong>Total álbumes:</strong> <span id="totalAlbums">0</span></p>
        <p><strong>Total canciones:</strong> <span id="totalCanciones">0</span></p>
        <p><strong>Total reproducciones aproximadas:</strong> <span id="totalReproducciones">0</span></p>
      </div>
    </section>

  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getDatabase, ref, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDiACaIKPXiSdcBo-bq4BW7z7gjpouVNos",
      authDomain: "flixplemusic.firebaseapp.com",
      databaseURL: "https://flixplemusic-default-rtdb.firebaseio.com",
      projectId: "flixplemusic",
      storageBucket: "flixplemusic.appspot.com",
      messagingSenderId: "792301053512",
      appId: "1:792301053512:web:13878703d081f1a7b3da7d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // JSONP para Deezer
    function jsonp(url) {
      return new Promise((resolve, reject) => {
        const callbackName = 'cb_' + Math.random().toString(36).substring(2, 9);
        window[callbackName] = (data) => {
          delete window[callbackName];
          script.remove();
          resolve(data);
        };
        const script = document.createElement('script');
        script.src = `${url}&output=jsonp&callback=${callbackName}`;
        script.onerror = () => {
          delete window[callbackName];
          script.remove();
          reject(new Error('Error al cargar JSONP'));
        };
        document.body.appendChild(script);
      });
    }

    // Extraer y limpiar nombre artista
    function getNombreArtistaFromURL() {
      const params = new URLSearchParams(window.location.search);
      let nombre = params.get('nombre') || '';
      if (nombre.startsWith('$delartista/')) {
        nombre = nombre.slice('$delartista/'.length);
      }
      return decodeURIComponent(nombre);
    }

    function renderHeader(artistData) {
      const foto = document.getElementById('fotoArtista');
      const nombre = document.getElementById('nombreArtista');
      const iconoVerificado = document.getElementById('iconoVerificado');

      foto.src = artistData.imagen || '';
      foto.alt = artistData.nombre || 'Artista';

      nombre.textContent = artistData.nombre || 'Artista';

      if (artistData.verificado) {
        iconoVerificado.classList.remove('hidden');
      } else {
        iconoVerificado.classList.add('hidden');
      }
    }

    function renderAlbums(albums) {
      const cont = document.getElementById('contenedorAlbums');
      cont.innerHTML = '';
      if (!albums.length) {
        cont.textContent = 'No se encontraron álbumes';
        return;
      }
      albums.forEach(a => {
        const div = document.createElement('div');
        div.className = 'min-w-[150px] bg-gray-800 rounded overflow-hidden shadow-md cursor-pointer hover:scale-105 transition-transform duration-200';
        div.title = a.title || a.album || a.nombre || 'Álbum';
        div.innerHTML = `
          <img src="${a.cover || a.imagen || ''}" alt="${a.title || a.album || 'Álbum'}" class="w-full h-32 object-cover" />
          <div class="p-2 text-center font-semibold truncate">${a.title || a.album || a.nombre}</div>
        `;
        cont.appendChild(div);
      });
    }

    function renderSongs(songs) {
      const cont = document.getElementById('contenedorCanciones');
      cont.innerHTML = '';
      if (!songs.length) {
        cont.textContent = 'No se encontraron canciones';
        return;
      }
      songs.forEach(s => {
        const div = document.createElement('div');
        div.className = 'p-2 bg-gray-700 rounded flex justify-between items-center';
        div.title = s.title || s.nombre || 'Canción';
        div.innerHTML = `
          <span class="truncate">${s.title || s.nombre}</span>
          <span class="text-sm text-gray-400">${formatDuration(s.duration)}</span>
        `;
        cont.appendChild(div);
      });
    }

    function formatDuration(seconds) {
      if (!seconds) return "0:00";
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return `${m}:${s.toString().padStart(2,'0')}`;
    }

    async function main() {
      const nombreArtista = getNombreArtistaFromURL();
      if (!nombreArtista) {
        alert('No se proporcionó el nombre del artista en la URL');
        return;
      }

      try {
        // Buscar artista por nombre
        const artistsRef = ref(db, 'artists');
        const q = query(artistsRef, orderByChild('nombre'), equalTo(nombreArtista));
        const snapshot = await get(q);

        if (!snapshot.exists()) {
          alert('Artista no encontrado en la base de datos');
          return;
        }

        const artistsData = snapshot.val();
        const artistKey = Object.keys(artistsData)[0];
        const artistData = artistsData[artistKey];

        renderHeader(artistData);

        // Álbumes
        const albumsQuery = query(ref(db, 'albums'), orderByChild('artista'), equalTo(artistData.nombre));
        const albumsSnap = await get(albumsQuery);
        const albums = [];
        if (albumsSnap.exists()) {
          albumsSnap.forEach(childSnap => albums.push(childSnap.val()));
        }
        renderAlbums(albums);

        // Canciones
        const tracksQuery = query(ref(db, 'tracks'), orderByChild('artist'), equalTo(artistData.nombre));
        const tracksSnap = await get(tracksQuery);
        const tracks = [];
        if (tracksSnap.exists()) {
          tracksSnap.forEach(childSnap => tracks.push(childSnap.val()));
        }
        renderSongs(tracks);

        // Reproducciones Deezer (opcional)
        if (!artistData.deezerId) {
          document.getElementById('totalReproducciones').textContent = 'N/A';
        } else {
          try {
            const topTracksRes = await jsonp(`https://api.deezer.com/artist/${artistData.deezerId}/top?limit=100`);
            const totalReproducciones = (topTracksRes.data || []).reduce((acc, t) => acc + (t.rank || 0), 0);
            document.getElementById('totalReproducciones').textContent = totalReproducciones.toLocaleString();
          } catch {
            document.getElementById('totalReproducciones').textContent = 'N/A';
          }
        }

        // Estadísticas
        document.getElementById('totalAlbums').textContent = albums.length.toLocaleString();
        document.getElementById('totalCanciones').textContent = tracks.length.toLocaleString();

      } catch (error) {
        alert('Error cargando datos: ' + error.message);
        console.error(error);
      }
    }

    window.onload = main;
  </script>
</body>
</html>
