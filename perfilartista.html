<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Perfil Artista</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: black;
      color: white;
      font-family: system-ui, sans-serif;
      padding: 1rem;
      max-width: 900px;
      margin: auto;
    }
    header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    header img#artistImage {
      border-radius: 9999px;
      width: 96px;
      height: 96px;
      border: 4px solid #22c55e;
      object-fit: cover;
    }
    .artist-name-container {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      font-weight: 700;
      font-size: 1.5rem;
      user-select: text;
    }
    #verifiedIcon {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
      display: none;
    }
    section.stats {
      margin-bottom: 2rem;
      font-size: 1.1rem;
      font-weight: 600;
      user-select: text;
    }
    section.stats p {
      margin: 0.3rem 0;
    }
    .albums, .tracks {
      display: flex;
      flex-wrap: nowrap;
      overflow-x: auto;
      gap: 1rem;
      padding-bottom: 1rem;
    }
    .album, .track {
      background: #27272a;
      border-radius: 0.5rem;
      padding: 0.5rem;
      min-width: 110px;
      cursor: pointer;
      transition: transform 0.2s;
      user-select: none;
    }
    .album img {
      width: 100%;
      border-radius: 0.5rem;
      object-fit: cover;
      aspect-ratio: 1 / 1;
    }
    .album:hover, .track:hover {
      transform: scale(1.05);
    }
    .track-info {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>
</head>
<body>

  <header>
    <img id="artistImage" alt="Foto artista" src="https://via.placeholder.com/96" />
    <div class="artist-name-container">
      <span id="artistName">Artista</span>
      <img id="verifiedIcon" src="https://cdn-icons-png.flaticon.com/512/11820/11820312.png" alt="Verificado" />
    </div>
  </header>

  <section class="stats">
    <p><strong>Total álbumes:</strong> <span id="totalAlbums">0</span></p>
    <p><strong>Total canciones:</strong> <span id="totalTracks">0</span></p>
  </section>

  <section>
    <h2>Álbumes</h2>
    <div id="albumsContainer" class="albums">Cargando álbumes...</div>
  </section>

  <section>
    <h2>Canciones</h2>
    <div id="tracksContainer" class="tracks">Cargando canciones...</div>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getDatabase, ref, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDiACaIKPXiSdcBo-bq4BW7z7gjpouVNos",
      authDomain: "flixplemusic.firebaseapp.com",
      databaseURL: "https://flixplemusic-default-rtdb.firebaseio.com",
      projectId: "flixplemusic",
      storageBucket: "flixplemusic.appspot.com",
      messagingSenderId: "792301053512",
      appId: "1:792301053512:web:13878703d081f1a7b3da7d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    function getNombreArtistaFromURL() {
      const params = new URLSearchParams(window.location.search);
      let nombre = params.get('nombre') || '';
      if (nombre.startsWith('$delartista/')) {
        nombre = nombre.substring('$delartista/'.length);
      }
      return decodeURIComponent(nombre);
    }

    function showError(msg) {
      alert(msg);
      document.getElementById('albumsContainer').textContent = 'Error al cargar álbumes.';
      document.getElementById('tracksContainer').textContent = 'Error al cargar canciones.';
    }

    async function main() {
      const nombreArtista = getNombreArtistaFromURL();
      if (!nombreArtista) {
        showError('No se especificó el nombre del artista en la URL');
        return;
      }

      try {
        // Buscar artista por nombre
        const artistsRef = ref(db, 'artists');
        const q = query(artistsRef, orderByChild('nombre'), equalTo(nombreArtista));
        const snapshot = await get(q);

        if (!snapshot.exists()) {
          showError('Artista no encontrado');
          return;
        }

        const artists = snapshot.val();
        const artistKey = Object.keys(artists)[0];
        const artist = artists[artistKey];

        document.getElementById('artistImage').src = artist.imagen || 'https://via.placeholder.com/96';
        document.getElementById('artistName').textContent = artist.nombre || 'Artista';
        if (artist.verificado) {
          document.getElementById('verifiedIcon').style.display = 'inline-block';
        } else {
          document.getElementById('verifiedIcon').style.display = 'none';
        }

        // Cargar álbumes y obtener el playlistId (ID de playlist)
        const albumsRef = ref(db, 'albums');
        const albumsQuery = query(albumsRef, orderByChild('artista'), equalTo(nombreArtista));
        const albumsSnap = await get(albumsQuery);
        const albumsContainer = document.getElementById('albumsContainer');
        albumsContainer.innerHTML = '';
        let albums = [];

        if (albumsSnap.exists()) {
          albumsSnap.forEach(childSnap => {
            const albumData = childSnap.val();
            albumData.key = childSnap.key; // ID del álbum en Firebase
            albums.push(albumData);
          });

          // Por cada álbum, buscamos playlist relacionado para obtener playlistId
          for (const album of albums) {
            // Busca la playlist cuyo album sea igual al nombre del álbum
            const playlistsRef = ref(db, 'playlists');
            const playlistsQuery = query(playlistsRef, orderByChild('album'), equalTo(album.album || album.title));
            const playlistsSnap = await get(playlistsQuery);

            let playlistId = null;
            if (playlistsSnap.exists()) {
              // Tomamos el primer playlist que coincida
              playlistId = Object.keys(playlistsSnap.val())[0];
            }

            const div = document.createElement('div');
            div.className = 'album';
            div.title = album.album || album.title || 'Álbum';
            div.tabIndex = 0;

            // Si hay playlistId, al hacer click abrimos reproductor con playlistId
            div.addEventListener('click', () => {
              if (playlistId) {
                window.location.href = `https://nimeapp.github.io/Flixplemusic/Reproductor.html?playlistId=${encodeURIComponent(playlistId)}`;
              } else {
                alert('No hay playlist asociada para este álbum.');
              }
            });
            div.addEventListener('keydown', e => {
              if (e.key === 'Enter') {
                if (playlistId) {
                  window.location.href = `https://nimeapp.github.io/Flixplemusic/Reproductor.html?playlistId=${encodeURIComponent(playlistId)}`;
                } else {
                  alert('No hay playlist asociada para este álbum.');
                }
              }
            });

            div.innerHTML = `
              <img src="${album.cover || 'https://via.placeholder.com/150'}" alt="${album.album || album.title}" />
              <div class="track-info">${album.album || album.title}</div>
            `;
            albumsContainer.appendChild(div);
          }
        } else {
          albumsContainer.textContent = 'No se encontraron álbumes';
        }

        // Cargar canciones y hacer click para abrir reproductor canción
        const tracksRef = ref(db, 'tracks');
        const tracksQuery = query(tracksRef, orderByChild('artist'), equalTo(nombreArtista));
        const tracksSnap = await get(tracksQuery);
        const tracksContainer = document.getElementById('tracksContainer');
        tracksContainer.innerHTML = '';
        let tracks = [];

        if (tracksSnap.exists()) {
          tracksSnap.forEach(childSnap => {
            const trackData = childSnap.val();
            trackData.key = childSnap.key; // ID canción
            tracks.push(trackData);
          });

          tracks.forEach(track => {
            const div = document.createElement('div');
            div.className = 'track';
            div.title = track.title || track.nombre || 'Canción';
            div.tabIndex = 0;
            div.addEventListener('click', () => {
              window.location.href = `https://nimeapp.github.io/Flixplemusic/reproductor2.html?trackId=${encodeURIComponent(track.key)}`;
            });
            div.addEventListener('keydown', e => {
              if (e.key === 'Enter') {
                window.location.href = `https://nimeapp.github.io/Flixplemusic/reproductor2.html?trackId=${encodeURIComponent(track.key)}`;
              }
            });
            div.innerHTML = `
              <div class="track-info">${track.title || track.nombre}</div>
            `;
            tracksContainer.appendChild(div);
          });
        } else {
          tracksContainer.textContent = 'No se encontraron canciones';
        }

        document.getElementById('totalAlbums').textContent = albums.length;
        document.getElementById('totalTracks').textContent = tracks.length;

      } catch (error) {
        showError('Error al cargar datos: ' + error.message);
        console.error(error);
      }
    }

    window.onload = main;
  </script>

</body>
</html>
