<!DOCTYPE html>
<html lang="es" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Crear Perfil Artista</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #modalNoEncontrado {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    #modalNoEncontrado .modal-content {
      background: #222;
      padding: 1.5rem;
      border-radius: 0.5rem;
      max-width: 300px;
      text-align: center;
      color: #eee;
      font-weight: bold;
      user-select: none;
      cursor: pointer;
    }
  </style>
</head>
<body class="bg-black text-white min-h-screen flex items-center justify-center p-4">

  <main class="bg-gray-900 rounded-lg p-6 max-w-lg w-full relative">
    <h1 class="text-3xl font-bold mb-6 text-center">Crear Perfil Artista</h1>

    <form id="formPerfil" class="space-y-4">

      <div>
        <label for="nombreArtista" class="block mb-1 font-semibold">Nombre del artista (Buscar en Deezer)</label>
        <input id="nombreArtista" name="nombreArtista" type="text" required
          placeholder="Ej: Coldplay" 
          class="w-full p-2 rounded text-black" />
      </div>

      <button id="btnBuscar" type="button" 
        class="w-full bg-blue-600 hover:bg-blue-700 py-2 rounded font-semibold">
        Buscar Artista
      </button>

      <div id="infoArtista" class="mt-4 hidden bg-gray-800 p-4 rounded flex items-center gap-4">
        <img id="imgArtista" src="" alt="Foto artista" 
          class="w-20 h-20 rounded-full border-4 border-green-400 object-cover" />
        <div>
          <h2 id="nombreEncontrado" class="text-xl font-bold flex items-center gap-1 select-none"></h2>
        </div>
      </div>

      <div class="flex items-center gap-2 mt-2">
        <input type="checkbox" id="verificado" />
        <label for="verificado" class="select-none">Artista Verificado</label>
      </div>

      <button type="submit" 
        class="w-full bg-green-600 hover:bg-green-700 py-2 rounded font-semibold mt-4">
        Guardar Perfil
      </button>
    </form>

    <div id="mensaje" class="mt-4 text-center font-semibold"></div>
    <div id="urlGuardada" class="mt-4 text-center break-words"></div>
  </main>

  <div id="modalNoEncontrado">
    <div class="modal-content">No se encontró datos de ese artista<br>(Toca cualquier parte para cerrar)</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDiACaIKPXiSdcBo-bq4BW7z7gjpouVNos",
      authDomain: "flixplemusic.firebaseapp.com",
      databaseURL: "https://flixplemusic-default-rtdb.firebaseio.com",
      projectId: "flixplemusic",
      storageBucket: "flixplemusic.appspot.com",
      messagingSenderId: "792301053512",
      appId: "1:792301053512:web:13878703d081f1a7b3da7d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const urlIconoVerificado = 'https://cdn-icons-png.flaticon.com/512/11820/11820312.png';

    function jsonp(url) {
      return new Promise((resolve, reject) => {
        const callbackName = 'cb_' + Math.random().toString(36).substring(2, 9);
        window[callbackName] = (data) => {
          delete window[callbackName];
          script.remove();
          resolve(data);
        };
        const script = document.createElement('script');
        script.src = `${url}&output=jsonp&callback=${callbackName}`;
        script.onerror = () => {
          delete window[callbackName];
          script.remove();
          reject(new Error('Error al cargar JSONP'));
        };
        document.body.appendChild(script);
      });
    }

    async function buscarArtista(nombre) {
      if (!nombre) throw new Error('Nombre de artista requerido');
      const url = `https://api.deezer.com/search/artist?q=${encodeURIComponent(nombre)}`;
      const res = await jsonp(url);
      if (!res.data || !res.data.length) throw new Error('Artista no encontrado');
      return res.data[0];
    }

    async function artistaExisteEnNodos(nombreArtista) {
      const nombreLower = nombreArtista.toLowerCase();
      const nodos = ['albums', 'playlists', 'tracks', 'artist_covers'];
      for (const nodo of nodos) {
        try {
          const snapshot = await get(ref(db, nodo));
          if (snapshot.exists()) {
            const datos = snapshot.val();
            for (const key in datos) {
              if (!datos.hasOwnProperty(key)) continue;
              const item = datos[key];
              const camposArtista = ['artist', 'artista'];
              for (const campo of camposArtista) {
                if (item[campo] && typeof item[campo] === 'string') {
                  if (item[campo].toLowerCase() === nombreLower) {
                    return true;
                  }
                }
              }
            }
          }
        } catch (e) {
          console.error('Error al buscar en nodo', nodo, e);
        }
      }
      return false;
    }

    const inputNombre = document.getElementById('nombreArtista');
    const btnBuscar = document.getElementById('btnBuscar');
    const infoArtista = document.getElementById('infoArtista');
    const imgArtista = document.getElementById('imgArtista');
    const nombreEncontrado = document.getElementById('nombreEncontrado');
    const checkboxVerificado = document.getElementById('verificado');
    const mensaje = document.getElementById('mensaje');
    const formPerfil = document.getElementById('formPerfil');
    const urlGuardadaDiv = document.getElementById('urlGuardada');
    const modalNoEncontrado = document.getElementById('modalNoEncontrado');

    let artistaActual = null;
    let usuarioAdmin = false;
    let userUID = null;

    function actualizarNombreConVerificado() {
      if (!artistaActual) return;
      nombreEncontrado.innerHTML = '';
      const spanNombre = document.createElement('span');
      spanNombre.textContent = artistaActual.name;
      nombreEncontrado.appendChild(spanNombre);
      if (checkboxVerificado.checked) {
        const imgVerificado = document.createElement('img');
        imgVerificado.src = urlIconoVerificado;
        imgVerificado.alt = 'Verificado';
        imgVerificado.className = 'w-5 h-5';
        imgVerificado.style.marginLeft = '4px';
        nombreEncontrado.appendChild(imgVerificado);
      }
    }

    btnBuscar.onclick = async () => {
      mensaje.textContent = '';
      infoArtista.classList.add('hidden');
      nombreEncontrado.innerHTML = '';
      checkboxVerificado.checked = false;
      urlGuardadaDiv.innerHTML = '';

      const nombre = inputNombre.value.trim();
      if (!nombre) {
        mensaje.textContent = 'Escribe el nombre de un artista';
        return;
      }
      mensaje.textContent = 'Buscando artista...';

      try {
        const artista = await buscarArtista(nombre);
        artistaActual = artista;
        imgArtista.src = artista.picture_medium;
        imgArtista.alt = artista.name;
        actualizarNombreConVerificado();
        infoArtista.classList.remove('hidden');
        mensaje.textContent = '';
      } catch (e) {
        artistaActual = null;
        mensaje.textContent = e.message;
      }
    };

    checkboxVerificado.addEventListener('change', actualizarNombreConVerificado);

    async function checkAdmin(uid) {
      try {
        const snapshot = await get(ref(db, `admins/${uid}`));
        if (snapshot.exists() && snapshot.val().role === "admin") {
          usuarioAdmin = true;
          mensaje.textContent = `Usuario admin autenticado: ${auth.currentUser.email || uid}`;
        } else {
          usuarioAdmin = false;
          mensaje.textContent = 'No tienes permisos para guardar perfiles.';
        }
      } catch {
        usuarioAdmin = false;
        mensaje.textContent = 'Error verificando permisos.';
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        userUID = user.uid;
        await checkAdmin(user.uid);
      } else {
        usuarioAdmin = false;
        userUID = null;
        mensaje.textContent = 'Debes iniciar sesión para crear perfiles';
      }
    });

    function mostrarModal() { modalNoEncontrado.style.display = 'flex'; }
    function ocultarModal() { modalNoEncontrado.style.display = 'none'; }
    modalNoEncontrado.addEventListener('click', ocultarModal);

    formPerfil.onsubmit = async (e) => {
      e.preventDefault();
      mensaje.textContent = '';
      urlGuardadaDiv.innerHTML = '';

      if (!usuarioAdmin) {
        mensaje.textContent = 'No tienes permisos para guardar.';
        return;
      }

      if (!artistaActual) {
        mensaje.textContent = 'Busca y selecciona un artista primero';
        return;
      }

      const nombreArtista = artistaActual.name;

      // Validar existencia en nodos
      const existe = await artistaExisteEnNodos(nombreArtista);
      if (!existe) { mostrarModal(); return; }

      // **GENERAR URL CON ESPACIOS CODIFICADOS**
      const nombreUrl = encodeURIComponent(nombreArtista); // <-- Aquí se conserva el nombre exacto
      const urlPerfil = `https://nimeapp.github.io/Flixplemusic/perfilartista.html?nombre=$delartista/${nombreUrl}`;

      const perfil = {
        deezerId: artistaActual.id,
        nombre: nombreArtista,
        imagen: artistaActual.picture_medium,
        verificado: checkboxVerificado.checked,
        creadoPor: userUID,
        creadoEn: new Date().toISOString(),
        perfilURL: urlPerfil
      };

      try {
        await set(ref(db, `artists/${perfil.deezerId}`), perfil);
        mensaje.textContent = 'Perfil guardado con éxito ✅';

        urlGuardadaDiv.innerHTML = `
          <p class="mb-2">URL del perfil:</p>
          <input type="text" readonly value="${urlPerfil}" id="urlPerfilInput"
            class="w-full p-2 text-black rounded" />
          <button id="btnCopiarUrl" class="mt-2 bg-blue-600 hover:bg-blue-700 py-1 px-3 rounded">
            Copiar URL
          </button>
        `;

        document.getElementById('btnCopiarUrl').onclick = () => {
          const input = document.getElementById('urlPerfilInput');
          input.select();
          input.setSelectionRange(0, 99999);
          navigator.clipboard.writeText(input.value)
            .then(() => { mensaje.textContent = 'URL copiada al portapapeles ✔️'; })
            .catch(() => { mensaje.textContent = 'Error al copiar URL'; });
        };

      } catch (error) {
        mensaje.textContent = 'Error al guardar perfil en Firebase.';
        console.error(error);
      }
    };
  </script>
</body>
</html>
