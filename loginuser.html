<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Login / Registro</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<style>
  body { background-color: #000; }
  .morado { color: #bb00ff; }
  .morado-bg { background-color: #bb00ff; }
  .borde-verde { border-color: #00ff80; }
  .cursor-pointer { cursor: pointer; }
  .modal-bg {
    background: rgba(0,0,0,0.75);
    position: fixed; inset: 0;
    display: flex; align-items: center; justify-content: center;
    z-index: 9999;
  }
</style>
</head>
<body class="min-h-screen flex items-center justify-center p-6 text-white">

<div class="w-full max-w-md p-8 rounded-2xl borde-verde border-2">
  <!-- Login -->
  <div id="container-login">
    <h1 class="text-3xl font-bold text-center morado mb-6">Iniciar Sesión</h1>
    <input id="login-email" type="email" placeholder="Correo electrónico"
      class="w-full p-3 mb-4 rounded-lg borde-verde border bg-black text-white placeholder-gray-400 focus:outline-none" />
    <div class="relative mb-4">
      <input id="login-password" type="password" placeholder="Contraseña"
        class="w-full p-3 rounded-lg borde-verde border bg-black text-white placeholder-gray-400 focus:outline-none pr-10" />
      <span id="toggle-login-password" class="absolute right-3 top-3 cursor-pointer morado">
        <i data-lucide="eye"></i>
      </span>
    </div>
    
    <label class="flex items-center mb-2 cursor-pointer select-none">
      <input type="checkbox" id="remember-me" class="mr-2 accent-[#00ff80]" />
      <span class="morado select-none">Recordar contraseña</span>
    </label>
    
    <button id="btn-login" class="w-full p-3 morado-bg rounded-lg font-bold hover:opacity-80 mb-3">Iniciar Sesión</button>

    <p class="text-center morado mb-4">
      <span id="forgot-password" class="cursor-pointer underline">¿Olvidaste tu contraseña?</span>
    </p>

    <p class="text-center morado">¿No tienes cuenta? <span id="show-register" class="cursor-pointer underline">Crear cuenta</span></p>
  </div>

  <!-- Registro -->
  <div id="container-register" class="hidden">
    <h1 class="text-3xl font-bold text-center morado mb-6">Crear Cuenta</h1>
    <input id="reg-name" type="text" placeholder="Nombre de usuario"
      class="w-full p-3 mb-4 rounded-lg borde-verde border bg-black text-white placeholder-gray-400 focus:outline-none" />
    <input id="reg-email" type="email" placeholder="Correo electrónico"
      class="w-full p-3 mb-4 rounded-lg borde-verde border bg-black text-white placeholder-gray-400 focus:outline-none" />
    <div class="relative mb-4">
      <input id="reg-password" type="password" placeholder="Contraseña"
        class="w-full p-3 rounded-lg borde-verde border bg-black text-white placeholder-gray-400 focus:outline-none pr-10" />
      <span id="toggle-reg-password" class="absolute right-3 top-3 cursor-pointer morado">
        <i data-lucide="eye"></i>
      </span>
    </div>
    <div class="relative mb-4">
      <input id="reg-password-confirm" type="password" placeholder="Confirmar contraseña"
        class="w-full p-3 rounded-lg borde-verde border bg-black text-white placeholder-gray-400 focus:outline-none pr-10" />
      <span id="toggle-reg-password-confirm" class="absolute right-3 top-3 cursor-pointer morado">
        <i data-lucide="eye"></i>
      </span>
    </div>
    <button id="btn-register" class="w-full p-3 morado-bg rounded-lg font-bold hover:opacity-80 mb-4">Crear Cuenta</button>
    <p class="text-center morado">¿Ya tienes cuenta? <span id="show-login" class="cursor-pointer underline">Iniciar sesión</span></p>
  </div>
</div>

<!-- Modal mensajes -->
<div id="modal-msg" class="modal-bg hidden">
  <div class="bg-black border-2 borde-verde p-6 rounded-lg max-w-sm text-center morado text-lg cursor-pointer" id="modal-content"></div>
</div>

<!-- Modal recuperar contraseña -->
<div id="modal-forgot" class="modal-bg hidden">
  <div class="bg-black border-2 borde-verde p-6 rounded-lg max-w-sm text-center text-white">
    <h2 class="text-xl font-bold morado mb-4">Recuperar Contraseña</h2>
    <input id="forgot-email" type="email" placeholder="Tu correo electrónico"
      class="w-full p-3 mb-4 rounded-lg borde-verde border bg-black text-white placeholder-gray-400 focus:outline-none" />
    <div class="flex justify-between">
      <button id="cancel-forgot" class="px-4 py-2 morado-bg rounded-lg font-bold hover:opacity-80">Cancelar</button>
      <button id="send-forgot" class="px-4 py-2 morado-bg rounded-lg font-bold hover:opacity-80">Enviar</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendEmailVerification, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getDatabase, ref, set, get, runTransaction } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDiACaIKPXiSdcBo-bq4BW7z7gjpouVNos",
  authDomain: "flixplemusic.firebaseapp.com",
  databaseURL: "https://flixplemusic-default-rtdb.firebaseio.com",
  projectId: "flixplemusic",
  storageBucket: "flixplemusic.firebasestorage.app",
  messagingSenderId: "792301053512",
  appId: "1:792301053512:web:13878703d081f1a7b3da7d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const loginEmail = document.getElementById('login-email');
const loginPassword = document.getElementById('login-password');
const rememberMeCheckbox = document.getElementById('remember-me');
const regName = document.getElementById('reg-name');
const regEmail = document.getElementById('reg-email');
const regPassword = document.getElementById('reg-password');
const regPasswordConfirm = document.getElementById('reg-password-confirm');

function showModal(msg) {
  const modalMsg = document.getElementById('modal-msg');
  const modalContent = document.getElementById('modal-content');
  modalContent.textContent = msg;
  modalMsg.classList.remove('hidden');
  modalMsg.addEventListener('click', () => modalMsg.classList.add('hidden'), { once: true });
}

function togglePassword(input, toggleId) {
  const iconSpan = document.getElementById(toggleId);
  const icon = iconSpan.querySelector('i');
  input.type = input.type === "password" ? "text" : "password";
  icon.setAttribute('data-lucide', input.type === "password" ? 'eye' : 'eye-off');
  lucide.createIcons();
}

// Mostrar contraseñas
document.getElementById('toggle-login-password').addEventListener('click', () => togglePassword(loginPassword, 'toggle-login-password'));
document.getElementById('toggle-reg-password').addEventListener('click', () => togglePassword(regPassword, 'toggle-reg-password'));
document.getElementById('toggle-reg-password-confirm').addEventListener('click', () => togglePassword(regPasswordConfirm, 'toggle-reg-password-confirm'));

// Cambio entre login y registro
document.getElementById('show-register').addEventListener('click', () => {
  document.getElementById('container-login').classList.add('hidden');
  document.getElementById('container-register').classList.remove('hidden');
});
document.getElementById('show-login').addEventListener('click', () => {
  document.getElementById('container-register').classList.add('hidden');
  document.getElementById('container-login').classList.remove('hidden');
});

// Validación de contraseña
function validarPassword(pwd) {
  return /^(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]).{8,}$/.test(pwd);
}

// Login
document.getElementById('btn-login').addEventListener('click', async () => {
  if (!loginEmail.value || !loginPassword.value) return showModal('Ingresa correo y contraseña.');
  try {
    await signInWithEmailAndPassword(auth, loginEmail.value.trim(), loginPassword.value);
    if (rememberMeCheckbox.checked) {
      localStorage.setItem('rememberMe', 'true');
      localStorage.setItem('email', loginEmail.value.trim());
      localStorage.setItem('password', loginPassword.value);
    } else {
      localStorage.clear();
    }
    window.location.href = 'https://nimeapp.github.io/Flixplemusic/index.html';
  } catch (err) {
    showModal(err.message);
  }
});

// Registro
document.getElementById('btn-register').addEventListener('click', async () => {
  if (!regName.value || !regEmail.value || !regPassword.value || !regPasswordConfirm.value)
    return showModal('Completa todos los campos.');
  if (regPassword.value !== regPasswordConfirm.value)
    return showModal('Las contraseñas no coinciden.');
  if (!validarPassword(regPassword.value))
    return showModal('La contraseña debe tener al menos 8 caracteres, mayúscula, número y símbolo.');

  try {
    const userCredential = await createUserWithEmailAndPassword(auth, regEmail.value.trim(), regPassword.value);

    // Actualizar contador con transacción segura
    const counterRef = ref(db, 'counters/users');
    const newUserNumber = await runTransaction(counterRef, (current) => {
      return (current || 0) + 1;
    });

    // Guardar datos del usuario
    const initials = regName.value.trim().split(/\s+/).map(w => w[0].toUpperCase()).slice(0,2).join('');
    const colors = ["#bb00ff", "#00ff80", "#ff0055", "#ff7700", "#00aaff", "#ffaa00", "#00ffaa", "#ff00aa"];
    const profileColor = colors[Math.floor(Math.random() * colors.length)];

    await set(ref(db, 'users/' + userCredential.user.uid), { 
      name: regName.value.trim(), 
      email: regEmail.value.trim(), 
      initials, 
      profileColor,
      userNumber: newUserNumber.snapshot.val(),
      createdAt: new Date().toISOString() 
    });

    await sendEmailVerification(userCredential.user, { url: 'https://nimeapp.github.io/Flixplemusic/loginuser.html' });
    showModal('Cuenta creada. Verifica tu correo.');
    document.getElementById('container-register').classList.add('hidden');
    document.getElementById('container-login').classList.remove('hidden');
  } catch (err) {
    showModal(err.message);
  }
});

// Recuperar contraseña
document.getElementById('forgot-password').addEventListener('click', () => {
  document.getElementById('forgot-email').value = '';
  document.getElementById('modal-forgot').classList.remove('hidden');
});
document.getElementById('cancel-forgot').addEventListener('click', () => {
  document.getElementById('modal-forgot').classList.add('hidden');
});
document.getElementById('send-forgot').addEventListener('click', async () => {
  const email = document.getElementById('forgot-email').value.trim();
  if (!email) return showModal('Ingresa un correo válido.');
  try {
    await sendPasswordResetEmail(auth, email, { url: 'https://nimeapp.github.io/Flixplemusic/reset_password.html' });
    showModal('Se ha enviado un enlace para cambiar tu contraseña.');
    document.getElementById('modal-forgot').classList.add('hidden');
  } catch (err) {
    showModal(err.message);
  }
});

// Rellenar datos si recordar contraseña está activo
window.addEventListener('load', () => {
  if (localStorage.getItem('rememberMe') === 'true') {
    loginEmail.value = localStorage.getItem('email') || '';
    loginPassword.value = localStorage.getItem('password') || '';
    rememberMeCheckbox.checked = true;
  }
});

lucide.createIcons();
</script>

</body>
</html>
