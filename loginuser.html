<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Login / Registro</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<style>
  body { background-color: #000; }
  .morado { color: #bb00ff; }
  .morado-bg { background-color: #bb00ff; }
  .borde-verde { border-color: #00ff80; }
  .cursor-pointer { cursor: pointer; }
  .modal-bg {
    background: rgba(0,0,0,0.75);
    position: fixed; inset: 0;
    display: flex; align-items: center; justify-content: center;
    z-index: 9999;
  }
</style>
</head>
<body class="min-h-screen flex items-center justify-center p-6 text-white">

<div class="w-full max-w-md p-8 rounded-2xl borde-verde border-2">
  <div id="container-login">
    <h1 class="text-3xl font-bold text-center morado mb-6">Iniciar Sesión</h1>
    <input id="login-email" type="email" placeholder="Correo electrónico"
      class="w-full p-3 mb-4 rounded-lg borde-verde border bg-black text-white placeholder-gray-400 focus:outline-none" />
    <div class="relative mb-4">
      <input id="login-password" type="password" placeholder="Contraseña"
        class="w-full p-3 rounded-lg borde-verde border bg-black text-white placeholder-gray-400 focus:outline-none pr-10" />
      <span id="toggle-login-password" class="absolute right-3 top-3 cursor-pointer text-morado">
        <i data-lucide="eye"></i>
      </span>
    </div>
    
    <label class="flex items-center mb-2 cursor-pointer select-none">
      <input type="checkbox" id="remember-me" class="mr-2 accent-[#00ff80]" />
      <span class="morado select-none">Recordar contraseña</span>
    </label>
    
    <button id="btn-login" class="w-full p-3 morado-bg rounded-lg font-bold hover:opacity-80 mb-3">Iniciar Sesión</button>

    <p class="text-center morado mb-4">
      <span id="forgot-password" class="cursor-pointer underline">¿Olvidaste tu contraseña?</span>
    </p>

    <p class="text-center morado">¿No tienes cuenta? <span id="show-register" class="cursor-pointer underline">Crear cuenta</span></p>
  </div>

  <div id="container-register" class="hidden">
    <h1 class="text-3xl font-bold text-center morado mb-6">Crear Cuenta</h1>
    <input id="reg-name" type="text" placeholder="Nombre de usuario"
      class="w-full p-3 mb-4 rounded-lg borde-verde border bg-black text-white placeholder-gray-400 focus:outline-none" />
    <input id="reg-email" type="email" placeholder="Correo electrónico"
      class="w-full p-3 mb-4 rounded-lg borde-verde border bg-black text-white placeholder-gray-400 focus:outline-none" />
    <div class="relative mb-4">
      <input id="reg-password" type="password" placeholder="Contraseña"
        class="w-full p-3 rounded-lg borde-verde border bg-black text-white placeholder-gray-400 focus:outline-none pr-10" />
      <span id="toggle-reg-password" class="absolute right-3 top-3 cursor-pointer text-morado">
        <i data-lucide="eye"></i>
      </span>
    </div>
    <div class="relative mb-4">
      <input id="reg-password-confirm" type="password" placeholder="Confirmar contraseña"
        class="w-full p-3 rounded-lg borde-verde border bg-black text-white placeholder-gray-400 focus:outline-none pr-10" />
      <span id="toggle-reg-password-confirm" class="absolute right-3 top-3 cursor-pointer text-morado">
        <i data-lucide="eye"></i>
      </span>
    </div>
    <button id="btn-register" class="w-full p-3 morado-bg rounded-lg font-bold hover:opacity-80 mb-4">Crear Cuenta</button>
    <p class="text-center morado">¿Ya tienes cuenta? <span id="show-login" class="cursor-pointer underline">Iniciar sesión</span></p>
  </div>
</div>

<!-- Modal para mostrar mensajes -->
<div id="modal-msg" class="modal-bg hidden" role="alert" aria-live="assertive" aria-atomic="true" tabindex="0">
  <div class="bg-black border-2 borde-verde p-6 rounded-lg max-w-sm text-center morado text-lg" id="modal-content"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendEmailVerification, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDiACaIKPXiSdcBo-bq4BW7z7gjpouVNos",
    authDomain: "flixplemusic.firebaseapp.com",
    databaseURL: "https://flixplemusic-default-rtdb.firebaseio.com",
    projectId: "flixplemusic",
    storageBucket: "flixplemusic.firebasestorage.app",
    messagingSenderId: "792301053512",
    appId: "1:792301053512:web:13878703d081f1a7b3da7d"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // Elementos DOM
  const containerLogin = document.getElementById('container-login');
  const containerRegister = document.getElementById('container-register');
  const showRegister = document.getElementById('show-register');
  const showLogin = document.getElementById('show-login');

  const loginEmail = document.getElementById('login-email');
  const loginPassword = document.getElementById('login-password');
  const btnLogin = document.getElementById('btn-login');
  const rememberMeCheckbox = document.getElementById('remember-me');

  const regName = document.getElementById('reg-name');
  const regEmail = document.getElementById('reg-email');
  const regPassword = document.getElementById('reg-password');
  const regPasswordConfirm = document.getElementById('reg-password-confirm');
  const btnRegister = document.getElementById('btn-register');

  const forgotPasswordLink = document.getElementById('forgot-password');

  // Modal mensaje
  const modalMsg = document.getElementById('modal-msg');
  const modalContent = document.getElementById('modal-content');

  // Funciones para modales
  function showModal(message) {
    modalContent.textContent = message;
    modalMsg.classList.remove('hidden');
    modalMsg.focus();

    function closeModal() {
      modalMsg.classList.add('hidden');
      modalMsg.removeEventListener('click', closeModal);
      clearTimeout(timeoutId);
    }

    modalMsg.addEventListener('click', closeModal);
    const timeoutId = setTimeout(() => {
      closeModal();
    }, 8000);
  }

  // Cambiar entre login y registro
  showRegister.addEventListener('click', () => {
    containerLogin.classList.add('hidden');
    containerRegister.classList.remove('hidden');
    clearFields();
  });

  showLogin.addEventListener('click', () => {
    containerRegister.classList.add('hidden');
    containerLogin.classList.remove('hidden');
    clearFields();
  });

  // Limpiar campos
  function clearFields() {
    loginEmail.value = '';
    loginPassword.value = '';
    regName.value = '';
    regEmail.value = '';
    regPassword.value = '';
    regPasswordConfirm.value = '';
  }

  // Validar contraseña fuerte
  function validarPassword(pwd) {
    const regex = /^(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]).{8,}$/;
    return regex.test(pwd);
  }

  // Enviar email para reset de contraseña
  async function sendPasswordReset(email) {
    try {
      await sendPasswordResetEmail(auth, email, {
        url: 'https://nimeapp.github.io/Flixplemusic/reset_password.html'
      });
      showModal('Se ha enviado un enlace para cambiar tu contraseña, revisa tu correo.');
    } catch(error) {
      showModal('Error al enviar correo: ' + error.message);
    }
  }

  forgotPasswordLink.addEventListener('click', () => {
    // Cambiado prompt por modal personalizado para mejor UI
    const email = prompt('Ingresa tu correo para enviar el enlace de recuperación:');
    if(email && email.trim() !== '') {
      sendPasswordReset(email.trim());
    }
  });

  // Toggle visibilidad contraseña
  function togglePassword(input, toggleId) {
    const iconSpan = document.getElementById(toggleId);
    const icon = iconSpan.querySelector('i');
    if (input.type === "password") {
      input.type = "text";
      icon.setAttribute('data-lucide', 'eye-off');
    } else {
      input.type = "password";
      icon.setAttribute('data-lucide', 'eye');
    }
    lucide.createIcons();
  }

  document.getElementById('toggle-login-password').addEventListener('click', () => {
    togglePassword(loginPassword, 'toggle-login-password');
  });
  document.getElementById('toggle-reg-password').addEventListener('click', () => {
    togglePassword(regPassword, 'toggle-reg-password');
  });
  document.getElementById('toggle-reg-password-confirm').addEventListener('click', () => {
    togglePassword(regPasswordConfirm, 'toggle-reg-password-confirm');
  });

  // Registro
  btnRegister.addEventListener('click', async () => {
    const name = regName.value.trim();
    const email = regEmail.value.trim();
    const pwd = regPassword.value;
    const pwdConf = regPasswordConfirm.value;

    if (!name || !email || !pwd || !pwdConf) {
      showModal('Completa todos los campos');
      return;
    }
    if (pwd !== pwdConf) {
      showModal('Las contraseñas no coinciden');
      return;
    }
    if (!validarPassword(pwd)) {
      showModal('La contraseña debe tener al menos 8 caracteres, una letra mayúscula, un número y un carácter especial.');
      return;
    }

    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, pwd);
      await set(ref(db, 'users/' + userCredential.user.uid), {
        name,
        email,
        createdAt: new Date().toISOString()
      });
      await sendEmailVerification(userCredential.user);
      showModal('Cuenta creada. Verifica tu correo, revisa también la carpeta spam.');
      containerRegister.classList.add('hidden');
      containerLogin.classList.remove('hidden');
      clearFields();
    } catch (error) {
      showModal('Error: ' + error.message);
    }
  });

  // Login
  btnLogin.addEventListener('click', async () => {
    const email = loginEmail.value.trim();
    const pwd = loginPassword.value;

    if (!email || !pwd) {
      showModal('Ingresa correo y contraseña');
      return;
    }

    try {
      await signInWithEmailAndPassword(auth, email, pwd);

      if(rememberMeCheckbox.checked) {
        localStorage.setItem('rememberMe', 'true');
        localStorage.setItem('email', email);
        localStorage.setItem('password', pwd);
      } else {
        localStorage.removeItem('rememberMe');
        localStorage.removeItem('email');
        localStorage.removeItem('password');
      }

      window.location.href = 'https://nimeapp.github.io/Flixplemusic/index.html';
    } catch (error) {
      showModal('Error: ' + error.message);
    }
  });

  // Login automático si recordado
  window.addEventListener('load', async () => {
    const remember = localStorage.getItem('rememberMe');
    const savedEmail = localStorage.getItem('email');
    const savedPassword = localStorage.getItem('password');
    if (remember && savedEmail && savedPassword) {
      try {
        await signInWithEmailAndPassword(auth, savedEmail, savedPassword);
        window.location.href = 'https://nimeapp.github.io/Flixplemusic/index.html';
      } catch {
        localStorage.removeItem('rememberMe');
        localStorage.removeItem('email');
        localStorage.removeItem('password');
      }
    }
  });

  lucide.createIcons();
</script>

</body>
</html>
